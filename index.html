<!doctype html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlanOS • Personal Planner</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#f6f8fd">
  <meta name="application-name" content="PlanOS">
  <meta name="apple-mobile-web-app-title" content="PlanOS">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Chart.js (CDN). Optional: you can bundle locally later. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* =========================
       IRANSansX (local WOFF2)
       Put files in: ./fonts/
       ========================= */
    @font-face{
      font-family: "IRANSansX";
      src: url("./fonts/IRANSansX-Light.woff2") format("woff2");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face{
      font-family: "IRANSansX";
      src: url("./fonts/IRANSansX-Medium.woff2") format("woff2");
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }
    @font-face{
      font-family: "IRANSansX";
      src: url("./fonts/IRANSansX-DemiBold.woff2") format("woff2");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }
    @font-face{
      font-family: "IRANSansX";
      src: url("./fonts/IRANSansX-Bold.woff2") format("woff2");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face{
      font-family: "IRANSansX";
      src: url("./fonts/IRANSansX-ExtraBold.woff2") format("woff2");
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }
@font-face{
  font-family: "IRANSansX";
  src: url("./fonts/IRANSansX-ExtraBold.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}

    /* =========================
       Design System (Tokens)
       ========================= */
    :root{
      --font-sans: "IRANSansX", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;

      --font-1: 12px;
      --font-2: 13px;
      --font-3: 14px;
      --font-4: 16px;
      --font-5: 20px;

      --fs-1: var(--font-1);
      --fs-2: var(--font-2);
      --fs-3: var(--font-3);
      --fs-4: var(--font-4);
      --fs-5: var(--font-5);

      --lh: 1.85;

      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;

      --s-1: var(--space-1);
      --s-2: var(--space-2);
      --s-3: var(--space-3);
      --s-4: var(--space-4);
      --s-5: var(--space-5);

      --radius-1: 12px;
      --radius-2: 16px;
      --radius-3: 20px;
      --radius-4: 28px;

      --r-1: var(--radius-1);
      --r-2: var(--radius-2);
      --r-3: var(--radius-3);
      --r-4: var(--radius-4);

      --sidebar: 292px;
      --gap: var(--s-3);

      /* Core light palette */
      --bg: #f6f8fd;
      --bg2: #eef2fb;
      --surface: #ffffff;
      --surface-2: #f4f7ff;
      --border: #d7deee;
      --text: #0f172a;
      --text-muted: #5b6b86;
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #16a34a;
      --shadow: 0 10px 28px rgba(15,23,42,.12);

      --surface-1: var(--surface);
      --surface-3: color-mix(in srgb, var(--surface-2) 72%, var(--surface) 28%);
      --surface-4: color-mix(in srgb, var(--surface-2) 84%, var(--surface) 16%);

      --muted: var(--text-muted);
      --muted-2: color-mix(in srgb, var(--text) 42%, var(--bg));

      --primary-soft: color-mix(in srgb, var(--primary) 14%, transparent);
      --primary-soft-2: color-mix(in srgb, var(--primary) 8%, transparent);
      --success-soft: color-mix(in srgb, var(--success) 14%, transparent);
      --warning: #f59e0b;
      --warning-soft: color-mix(in srgb, var(--warning) 16%, transparent);
      --danger-soft: color-mix(in srgb, var(--danger) 14%, transparent);

      --shadow-1: var(--shadow);
      --shadow-2: 0 18px 54px rgba(15,23,42,.16);

      --ring: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent);

      --border-strong: color-mix(in srgb, var(--primary) 30%, var(--border));
      --scrollbar-thumb: color-mix(in srgb, var(--text) 28%, transparent);
      --overlay: rgba(15,23,42,.32);
      --overlay-strong: rgba(15,23,42,.5);

      --grad:
        radial-gradient(950px 520px at 8% 10%, var(--primary-soft), transparent 60%),
        radial-gradient(980px 520px at 96% 26%, color-mix(in srgb, var(--success) 12%, transparent), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));

      --flip-bg: color-mix(in srgb, var(--surface-2) 70%, var(--surface) 30%);
      --flip-border: color-mix(in srgb, var(--border) 70%, transparent);
      --flip-highlight: color-mix(in srgb, #fff 10%, transparent);
      --date-card-bg: color-mix(in srgb, var(--surface-2) 80%, transparent);
    }
html, body {
  font-family: var(--font-sans);
  font-variant-numeric: lining-nums tabular-nums;
}

button, input, textarea, select {
  font-family: inherit;
}

* {
  font-family: inherit;
}

canvas {
  font-family: var(--font-sans);
}

    html[data-theme="dark"]{
      /* Optional dark palette */
      --bg: #090d16;
      --bg2: #0b1122;
      --surface: rgba(255,255,255,.03);
      --surface-2: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --text-muted: rgba(255,255,255,.66);
      --primary: #9ae6ff;
      --danger: #ff7b7b;
      --success: #7bffb5;
      --shadow: 0 10px 30px rgba(0,0,0,.28);
      --overlay: rgba(0,0,0,.55);
      --overlay-strong: rgba(0,0,0,.6);
      --border-strong: rgba(154,230,255,.32);
      --scrollbar-thumb: rgba(255,255,255,.16);
      --flip-bg: color-mix(in srgb, rgba(0,0,0,.35) 40%, var(--surface-2) 60%);
      --flip-border: color-mix(in srgb, rgba(255,255,255,.08) 70%, transparent);
      --flip-highlight: color-mix(in srgb, rgba(255,255,255,.18) 60%, transparent);
      --date-card-bg: color-mix(in srgb, rgba(255,255,255,.08) 60%, transparent);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      overflow-x: hidden;
    }
    body{
      margin:0;
      font-family: var(--font-sans);
      font-size: var(--fs-4);
      color: var(--text);
      background: var(--grad);
      line-height: var(--lh);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    @keyframes viewIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    :where(button, input, select, textarea, a):focus-visible{
      outline: none;
      box-shadow: var(--ring);
      border-color: color-mix(in srgb, var(--border) 50%, var(--primary) 50%);
    }

    .app{
      display:grid;
      grid-template-columns: var(--sidebar) 1fr;
      align-items: start;
      gap: var(--gap);
      width: min(1360px, 100%);
      margin: 0 auto;
      padding: calc(var(--s-4) + env(safe-area-inset-top, 0px))
        calc(var(--s-4) + env(safe-area-inset-right, 0px))
        calc(var(--s-4) + env(safe-area-inset-bottom, 0px))
        calc(var(--s-4) + env(safe-area-inset-left, 0px));
    }
    @media (max-width: 1120px){
      .app{ grid-template-columns: 1fr; }
    }

    .glass{
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 86%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow-2);
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top: var(--s-4);
      height: calc(100vh - (var(--s-4) * 2));
      border-radius: var(--r-4);
      overflow: auto;
      display:flex;
      flex-direction:column;
      min-height: 0;
      transition: opacity .2s ease, filter .2s ease, transform .2s ease;
    }
    .side-top{
      padding: var(--s-4);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--surface-3), transparent);
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s-2);
    }
    .brand h1{
      margin:0;
      font-size: var(--fs-5);
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .badge{
      font-size: var(--fs-1);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-3);
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }

    .profile{
      margin-top: var(--s-3);
      display:flex;
      gap: var(--s-2);
      align-items:flex-start;
      cursor: pointer;
    }
    .profile:focus-visible{
      outline: none;
      box-shadow: var(--ring);
      border-radius: 18px;
    }
    .avatar{
      width:46px;height:46px;border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, var(--primary-soft), var(--success-soft));
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      box-shadow: var(--shadow-1);
      flex: 0 0 auto;
      overflow: auto;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .pname{ font-weight:800; font-size: var(--fs-4); }
    .ptitle{ font-size: var(--fs-1); color: var(--muted); margin-top: 2px; }

    .nav{
      padding: var(--s-3);
      display:grid;
      gap: 10px;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
    }
    .nav::-webkit-scrollbar{ width: 8px; }
    .nav::-webkit-scrollbar-thumb{
      background: var(--scrollbar-thumb);
      border-radius: 999px;
    }
    .nav::-webkit-scrollbar-track{ background: transparent; }
    .nav button{
      width:100%;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-1) 85%, var(--surface-2) 15%);
      color: var(--text);
      border-radius: var(--r-3);
      padding: 12px 12px;
      min-height: 52px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease;
      text-align:right;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s-2);
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
    }
    .nav button:hover{
      transform: translateY(-1px);
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .nav button.active{
      background: linear-gradient(135deg, var(--primary-soft), var(--success-soft));
      border-color: var(--border-strong);
      box-shadow: 0 12px 26px color-mix(in srgb, var(--primary) 16%, transparent);
    }
    .nav-left{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
    }
    .nav-ic{
      width: 38px;
      height: 38px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-3) 70%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow-1);
      flex: 0 0 auto;
      color: var(--text);
    }
    .nav button.active .nav-ic{
      border-color: var(--border-strong);
      box-shadow: 0 10px 22px color-mix(in srgb, var(--primary) 20%, transparent);
    }
    .nav-ic svg{ width: 18px; height: 18px; opacity: .95; }
    .nav-text{ min-width: 0; }
    .nav-title{ font-size: var(--fs-3); font-weight: 800; line-height: 1.25; }
    .nav-hint{ font-size: var(--fs-1); color: var(--muted); margin-top: 2px; }
    .nav-arrow{
      color: var(--muted);
      font-size: var(--fs-2);
      user-select:none;
    }

    .side-bottom{
      margin-top:auto;
      padding: var(--s-2) var(--s-3) var(--s-3);
      border-top: 1px solid var(--border);
      display:grid;
      gap: 10px;
      background: linear-gradient(0deg, var(--surface-3), transparent);
    }

    .side-actions-group{
      display:grid;
      gap: 8px;
    }
    .side-actions-title{
      font-size: var(--fs-1);
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .2px;
    }
    .btn-row{ display:flex; gap: 10px; flex-wrap:wrap; }
    .side-actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .side-actions.primary{
      padding: 8px;
      border-radius: var(--r-3);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--primary) 8%, var(--surface-2) 92%), var(--surface-2));
    }
    .side-actions.secondary{
      padding: 10px;
      border-radius: var(--r-3);
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 70%, transparent);
    }
    .side-actions .btn{
      width: 100%;
      justify-content: flex-start;
      min-height: 44px;
      padding: 8px 12px;
      border-radius: 16px;
      gap: 10px;
    }
    .side-actions.primary .btn{
      border-color: color-mix(in srgb, var(--primary) 28%, var(--border));
      background: color-mix(in srgb, var(--primary) 8%, var(--surface));
      font-weight: 700;
    }
    .btn-emoji{
      width: 24px;
      height: 24px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
    }
    .btn-label{
      font-weight: 700;
      font-size: var(--fs-2);
      white-space: nowrap;
    }
    .side-actions .btn-label{
      flex: 1;
      min-width: 0;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .more-drawer{
      display:grid;
      gap: 10px;
    }
    .more-toggle{
      width: 100%;
      justify-content: space-between;
      min-height: 46px;
      border-radius: 16px;
      padding: 10px 12px;
    }
    .more-toggle:focus-visible{
      outline: none;
      box-shadow: var(--ring);
    }
    .more-label{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 700;
      font-size: var(--fs-2);
    }
    .more-chevron{
      width: 22px;
      height: 22px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      transition: transform .22s ease, background .22s ease, border-color .22s ease;
    }
    .more-drawer.is-open .more-chevron{
      transform: rotate(180deg);
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .more-panel{
      border-radius: var(--r-3);
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 78%, transparent);
      box-shadow: 0 12px 28px rgba(15,23,42,.12);
      padding: 10px;
      display:grid;
      gap: 8px;
      overflow: auto;
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: max-height .28s ease, opacity .2s ease, transform .2s ease;
    }
    .more-drawer.is-open .more-panel{
      max-height: 360px;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .more-panel-title{
      font-size: var(--fs-1);
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .2px;
      padding: 0 2px;
    }
    /* Button system */
    .btn{
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: var(--r-3);
      padding: 10px 14px;
      min-height: 44px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease;
      font-size: var(--fs-2);
      font-weight: 600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select:none;
      line-height: 1.4;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15,23,42,.08);
    }
    .btn:active{
      transform: translateY(0) scale(.98);
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
    }
    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary{
      background: var(--surface-2);
      border-color: var(--border);
    }
    .btn-secondary:hover{
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .btn-primary{
      background: var(--primary);
      color: #fff;
      border-color: color-mix(in srgb, var(--primary) 70%, var(--border));
      box-shadow: 0 10px 20px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .btn-primary:hover{ filter: brightness(.96); }
    .btn-danger{
      background: var(--danger);
      color: #fff;
      border-color: color-mix(in srgb, var(--danger) 60%, var(--border));
      box-shadow: 0 8px 18px color-mix(in srgb, var(--danger) 18%, transparent);
    }
    .btn-danger:hover{ filter: brightness(.96); }
    .btn-ghost{
      background: transparent;
      border-color: transparent;
      color: var(--text);
    }
    .btn-ghost:hover{
      background: var(--surface-2);
      border-color: var(--border);
    }
    .btn-icon,
    .icon-btn{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      padding: 0;
      background: var(--surface-2);
      color: var(--text);
      border-color: var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .btn-icon:hover,
    .icon-btn:hover{
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }

    /* Content */
    .content{
      border-radius: var(--r-4);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      padding: var(--s-4);
      border-bottom: 1px solid var(--border);
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap: var(--s-3);
      align-items:center;
      background: linear-gradient(180deg, var(--surface-3), transparent);
    }
    .topbar-left,
    .topbar-right{
      display:flex;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .topbar-main{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
      text-align: center;
    }
    .topbar-title{
      font-size: var(--fs-5);
      font-weight: 900;
      margin:0;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    :dir(rtl) .topbar-title{
      flex-direction: row-reverse;
    }
    .topbar-title .title-icon{
      width: 34px;
      height: 34px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-2) 70%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow-1);
      flex: 0 0 auto;
    }
    .topbar-title .title-icon svg{
      width: 18px;
      height: 18px;
    }
    .topbar-sub{
      font-size: var(--fs-1);
      color: var(--muted);
    }
    .topbar-actions{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .date-card{
      display:grid;
      gap: 6px;
      padding: 12px 14px;
      min-width: 170px;
      border-radius: 18px;
      border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background:
        radial-gradient(120px 80px at 90% 10%, color-mix(in srgb, var(--primary) 20%, transparent), transparent 60%),
        linear-gradient(180deg, color-mix(in srgb, var(--surface-2) 80%, transparent), color-mix(in srgb, var(--surface-1) 90%, transparent));
      box-shadow: var(--shadow-1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    .date-card::after{
      content:"";
      position:absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,.18), transparent 50%);
      pointer-events:none;
    }
    .date-card-weekday{
      font-size: var(--fs-1);
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .2px;
    }
    .date-card-day{
      font-size: 30px;
      font-weight: 900;
      line-height: 1;
      letter-spacing: .4px;
    }
    .date-card-footer{
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: var(--fs-2);
    }
    .date-card-month{
      font-weight: 700;
      color: var(--text);
    }
    .date-card-year{
      font-size: var(--fs-1);
      color: var(--muted);
    }
    .flip-clock{
      display:flex;
      align-items:center;
      gap: 6px;
      direction: ltr;
    }
    .flip-seg{
      display:flex;
      gap: 6px;
    }
    .flip-digit{
      position: relative;
      width: 32px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--flip-border);
      background: var(--flip-bg);
      color: var(--text);
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight: 800;
      font-size: 20px;
      box-shadow: inset 0 1px 0 var(--flip-highlight), 0 8px 16px rgba(15,23,42,.08);
      overflow: hidden;
    }
    .flip-digit .flip-value{
      position: relative;
      z-index: 1;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }
    .flip-digit::before{
      content:"";
      position:absolute;
      left:0;
      right:0;
      top:50%;
      height:1px;
      background: color-mix(in srgb, var(--flip-border) 80%, transparent);
      opacity: .7;
    }
    .flip-digit.is-flipping{
      animation: flipPulse .4s ease;
    }
    .flip-colon{
      font-weight: 800;
      color: var(--muted);
      margin: 0 2px;
      animation: blink 1s infinite;
    }
    @keyframes flipPulse{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(-2px); }
      100%{ transform: translateY(0); }
    }
    @keyframes blink{
      0%, 40%{ opacity: 1; }
      60%, 100%{ opacity: .4; }
    }
    .focus-btn{
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      border-radius: var(--r-3);
      padding: 8px 12px;
      min-height: 44px;
      display:flex;
      align-items:center;
      gap: 12px;
      cursor:pointer;
      font-size: var(--fs-2);
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease;
    }
    .focus-btn:hover{
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
      transform: translateY(-1px);
    }
    .focus-btn:active{
      transform: translateY(0) scale(.98);
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
    }
    .focus-btn.is-active{
      border-color: color-mix(in srgb, var(--primary) 60%, var(--border));
      background: color-mix(in srgb, var(--primary) 12%, var(--surface-2) 88%);
    }
    .focus-icon{
      width: 30px;
      height: 30px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: color-mix(in srgb, var(--primary) 14%, transparent);
      font-size: 16px;
    }
    .focus-text{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap: 2px;
      min-width: 0;
    }
    .focus-title{
      font-weight: 800;
      font-size: var(--fs-2);
    }
    .focus-state{
      font-size: var(--fs-1);
      color: var(--muted);
    }
    .focus-indicator{
      margin-inline-start: auto;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--border);
      box-shadow: inset 0 0 0 2px var(--surface-1);
    }
    .focus-btn.is-active .focus-indicator{
      background: var(--success);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--success) 30%, transparent);
    }
    .toggle-btn{
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      min-height: 44px;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      font-size: var(--fs-2);
      font-weight: 700;
      cursor:pointer;
      transition: background .14s ease, border-color .14s ease, box-shadow .14s ease;
      box-shadow: 0 8px 18px rgba(15,23,42,.08);
    }
    .toggle-btn:hover{
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .toggle-track{
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--border) 70%, transparent);
      position: relative;
      flex: 0 0 auto;
    }
    .toggle-thumb{
      position:absolute;
      inset-inline-start: 2px;
      top: 2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: var(--surface-1);
      box-shadow: 0 6px 12px rgba(15,23,42,.2);
      transition: transform .2s ease, background .2s ease;
    }
    .toggle-btn.is-active .toggle-track{
      background: color-mix(in srgb, var(--primary) 55%, var(--success) 45%);
    }
    .toggle-btn.is-active .toggle-thumb{
      transform: translateX(18px);
      background: #fff;
    }
    :dir(rtl) .toggle-btn.is-active .toggle-thumb{
      transform: translateX(-18px);
    }
    .toggle-state{
      font-size: var(--fs-1);
      color: var(--muted);
      min-width: 48px;
      text-align:center;
    }

    .views{ padding: var(--s-4); }
    .view{ display:none; }
    .view.active{ display:block; animation: viewIn .22s ease both; }

    /* Cards & grid */
    .grid{ display:grid; gap: var(--gap); }
    .grid.cols-12{ grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    @media (max-width: 1120px){
      .col-8,.col-6,.col-4{ grid-column: span 12; }
    }

    .card{
      border: 1px solid var(--border);
      background: var(--surface-2);
      border-radius: var(--r-3);
      padding: var(--s-4);
      box-shadow: var(--shadow-1);
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease, opacity .2s ease, filter .2s ease;
      display:flex;
      flex-direction:column;
      gap: var(--s-3);
    }

    .empty-state{
      border: 1px dashed color-mix(in srgb, var(--border) 70%, var(--primary) 30%);
      background: linear-gradient(180deg, var(--surface-3), transparent);
      border-radius: var(--r-3);
      padding: var(--s-4);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s-3);
    }
    .empty-icon{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      background: var(--primary-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      flex: 0 0 auto;
    }
    .empty-text{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .empty-title{ font-weight: 800; font-size: var(--fs-3); }
    .empty-sub{ font-size: var(--fs-1); color: var(--muted); }
    .empty-actions{ display:flex; gap: 8px; flex-wrap:wrap; }

    body.focus-mode .sidebar{
      opacity: .42;
      filter: grayscale(.25);
      transform: scale(.99);
    }
    body.focus-mode .sidebar:hover{
      opacity: .88;
      filter: none;
    }
    body.focus-mode .focus-scope .card{
      opacity: .5;
      filter: grayscale(.15);
    }
    body.focus-mode .focus-scope .card.focus-priority{
      opacity: 1;
      filter: none;
      transform: translateY(-2px);
      box-shadow: var(--shadow-2);
      border-color: var(--border-strong);
    }
    @media (hover: hover){
      .card:hover{
        transform: translateY(-1px);
        background: var(--surface-3);
        border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
      }
    }
    .card.primary{
      background: var(--surface-1);
      border-color: var(--border-strong);
      box-shadow: var(--shadow-2);
    }
    .card.secondary{
      background: var(--surface-2);
    }
    .card.passive{
      background: var(--surface-4);
      border-color: color-mix(in srgb, var(--border) 70%, transparent);
      box-shadow: none;
    }
    .card.passive:hover{
      transform: none;
      background: var(--surface-4);
      border-color: color-mix(in srgb, var(--border) 70%, transparent);
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s-3);
      flex-wrap:wrap;
    }
    .card-title-group{
      display:flex;
      align-items:flex-start;
      gap: var(--s-2);
      min-width: 0;
    }
    .card-icon{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface-3);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
      color: var(--text);
      box-shadow: var(--shadow-1);
      flex: 0 0 auto;
    }
    .card.primary .card-icon{
      border-color: var(--border-strong);
      box-shadow: 0 12px 22px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .card.passive .card-icon{
      background: var(--surface-2);
      color: var(--muted);
      box-shadow: none;
    }
    .card-title{
      margin:0;
      font-size: var(--fs-3);
      font-weight: 800;
    }
    .card.primary .card-title{
      font-weight: 900;
    }
    .card.passive .card-title{
      color: var(--muted);
    }
    .card-subtitle{
      font-size: var(--fs-1);
      color: var(--muted);
      margin-top: 2px;
    }
    .card-body{
      display:flex;
      flex-direction:column;
      gap: var(--s-3);
      min-width: 0;
    }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted-2); }
    .small{ font-size: var(--fs-1); }
    .kpi{
      font-size: 26px;
      font-weight: 900;
      margin-top: 6px;
      letter-spacing: .2px;
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .input, select, textarea{
      width:100%;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      outline:none;
      font-family: inherit;
      font-size: var(--fs-2);
      transition: border-color .14s ease, background .14s ease, box-shadow .14s ease;
    }
    textarea{ min-height: 110px; resize: vertical; }
    label{ font-size: var(--fs-1); color: var(--muted); display:block; margin: 8px 0 6px; }

    .form-grid{
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(2, 1fr);
    }
    .form-grid .full{ grid-column: span 2; }
    @media (max-width: 720px){
      .form-grid{ grid-template-columns: 1fr; }
      .form-grid .full{ grid-column: span 1; }
      table{
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    .chips{ display:flex; flex-wrap:wrap; gap: 8px; }
    .chip{
      border: 1px solid var(--border);
      background: var(--surface-2);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: var(--fs-1);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 6px;
      user-select:none;
    }
    .chip.ok{ border-color: color-mix(in srgb, var(--success) 30%, transparent); color: var(--success); }
    .chip.warn{ border-color: color-mix(in srgb, var(--warning) 30%, transparent); color: var(--warning); }
    .chip.danger{ border-color: color-mix(in srgb, var(--danger) 30%, transparent); color: var(--danger); }
    .chip.acc{ border-color: color-mix(in srgb, var(--primary) 30%, transparent); color: var(--primary); }

    /* Lists */
    .list{ display:grid; gap: 10px; }
    .item{
      border: 1px solid var(--border);
      background: var(--surface-1);
      border-radius: var(--r-3);
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      justify-content:space-between;
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .item-main{ flex:1; min-width: 0; }
    .item-title{
      font-weight: 900;
      margin:0 0 3px 0;
      font-size: var(--fs-3);
      overflow-wrap: anywhere;
    }
    .item-actions{
      display:flex;
      gap: 6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .item.done{
      background: color-mix(in srgb, var(--surface-2) 75%, transparent);
      border-color: color-mix(in srgb, var(--success) 20%, var(--border));
      box-shadow: none;
    }
    .item.done .item-title{
      text-decoration: line-through;
      color: var(--muted);
    }
    .item.task-complete{
      animation: taskComplete .22s ease both;
    }

    @keyframes taskComplete{
      0%{ transform: scale(1); }
      60%{ transform: scale(1.01); }
      100%{ transform: scale(1); }
    }
    .item-meta{
      display:flex; flex-wrap:wrap; gap: 8px;
      font-size: var(--fs-1);
      color: var(--muted);
    }

    .icon-btn.danger,
    .btn-icon.btn-danger{
      border-color: color-mix(in srgb, var(--danger) 30%, transparent);
      color: #fff;
      background: var(--danger);
    }

    /* Progress bar */
    .bar{
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: var(--surface-4);
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transition: width .22s ease;
    }

    /* Calendar */
    .cal-head{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    #view-calendar .card{
      overflow: hidden;
    }
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
    }
    .cal-dow{
      font-size: var(--fs-1);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface-1);
      text-align:center;
    }
    .cal-day{
      border: 1px solid var(--border);
      background: var(--surface-1);
      border-radius: var(--r-3);
      padding: 10px;
      min-height: 94px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
    }
    .cal-day:hover{
      transform: translateY(-1px);
      background: var(--surface-3);
      border-color: color-mix(in srgb, var(--border) 60%, var(--primary) 40%);
    }
    .cal-day.blank{ opacity:.35; cursor:default; }
    .cal-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .cal-num{ font-weight: 900; }
    .cal-badges{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      min-width: 0;
    }

    .mini{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: var(--surface-2);
      white-space:nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mini.ok{ border-color: color-mix(in srgb, var(--success) 28%, transparent); color: var(--success); }
    .mini.acc{ border-color: color-mix(in srgb, var(--primary) 28%, transparent); color: var(--primary); }

    /* Tables */
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    th{
      text-align:right;
      font-size: var(--fs-1);
      color: var(--muted);
      font-weight: 800;
      padding: 0 10px;
    }
    td{
      padding: 12px 10px;
      background: var(--surface-1);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    td:first-child{ border-right: 1px solid var(--border); border-top-right-radius: 16px; border-bottom-right-radius: 16px; }
    td:last-child{ border-left: 1px solid var(--border); border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
    .nowrap{ white-space:nowrap; }

    /* Dialog */
    dialog{
      border: none;
      padding: 0;
      background: transparent;
      color: var(--text);
      overflow: visible;
      width: auto;
      max-height: none;
      z-index: 9999;
    }
    dialog:not([open]){
      display: none;
    }
    dialog::backdrop{
      background: var(--overlay);
      position: fixed;
      inset: 0;
      z-index: 9998;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal-overlay{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: calc(16px + env(safe-area-inset-top, 0px))
        calc(16px + env(safe-area-inset-right, 0px))
        calc(16px + env(safe-area-inset-bottom, 0px))
        calc(16px + env(safe-area-inset-left, 0px));
      z-index: 9999;
    }
    @supports (height: 100dvh){
      .modal-overlay{ height: 100dvh; }
    }
    .modal-card{
      border: 1px solid var(--border);
      border-radius: 26px;
      background: color-mix(in srgb, var(--surface-3) 85%, transparent);
      box-shadow: var(--shadow-2);
      width: min(760px, 92vw);
      max-height: calc(100vh - 32px);
      padding: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    @supports (height: 100dvh){
      .modal-card{ max-height: calc(100dvh - 32px); }
    }
    .dlg-head{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, var(--surface-3), transparent);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .dlg-title{ font-weight: 1000; margin:0; font-size: var(--fs-4); }
    .dlg-sub{ font-size: var(--fs-1); color: var(--muted); margin-top:4px; }
    .dlg-body{
      padding: 14px;
      overflow-y: visible;
      flex: 1 1 auto;
    }
    .dlg-foot{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(0deg, var(--surface-3), transparent);
      position: sticky;
      bottom: 0;
      z-index: 2;
    }
    html.modal-open,
    body.modal-open{
      overflow: hidden;
      height: 100%;
      touch-action: none;
      overscroll-behavior: contain;
    }
    @media (max-width: 480px){
      .modal-card{
        width: calc(100% - 24px);
        margin: auto;
      }
      .dlg-foot{
        padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
      }
      .dlg-body{
        padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
      }
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 18px;
      bottom: calc(18px + env(safe-area-inset-bottom, 0px));
      border: 1px solid var(--border);
      background: var(--surface-4);
      backdrop-filter: blur(12px);
      color: var(--text);
      border-radius: 18px;
      padding: 10px 12px;
      display:none;
      max-width: min(420px, 92vw);
      box-shadow: var(--shadow-2);
      font-size: var(--fs-2);
      animation: viewIn .18s ease both;
      z-index: 9998;
    }

    .sep{ height:1px; background: var(--border); margin: 10px 0; opacity:.9; }

    /* =========================
       Lock Screen (PIN)
       ========================= */
    .lock-screen{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none; /* shown via JS */
      align-items: center;
      justify-content: center;
      padding: var(--s-4);
      background:
        radial-gradient(800px 420px at 10% 10%, var(--primary-soft), transparent 60%),
        radial-gradient(900px 420px at 90% 70%, var(--success-soft), transparent 55%),
        var(--overlay-strong);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .lock-card{
      width: min(520px, 94vw);
      border-radius: var(--r-4);
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface-3) 90%, transparent);
      box-shadow: var(--shadow-2);
      padding: var(--s-5);
      text-align: center;
    }
    .lock-title{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .lock-sub{
      margin-top: 6px;
      font-size: var(--fs-2);
      color: var(--muted);
    }
    .pin-row{
      display:flex;
      gap: 10px;
      justify-content:center;
      margin-top: var(--s-4);
      direction: ltr;
    }
    .pin{
      width: 52px;
      height: 56px;
      text-align:center;
      font-size: 22px;
      font-weight: 900;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      outline: none;
    }
    .lock-actions{
      margin-top: var(--s-4);
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .lock-error{
      margin-top: 10px;
      font-size: var(--fs-2);
      color: var(--danger);
      min-height: 1.6em;
    }
    /* =========================
       Mobile overrides (layout + overflow)
       ========================= */
    @media (max-width: 1120px){
      .sidebar{
        position: static;
        height: auto;
        overflow: visible;
      }
      .nav{
        flex: 0 0 auto;
        min-height: auto;
        overflow: visible;
      }
      .side-bottom{
        margin-top: var(--s-3);
      }
    }

    @media (max-width: 560px){
      :root{
        --sidebar: 100%;
        --gap: 12px;
      }

      .app{
        width: 100%;
        padding: calc(12px + env(safe-area-inset-top, 0px))
          calc(12px + env(safe-area-inset-right, 0px))
          calc(16px + env(safe-area-inset-bottom, 0px))
          calc(12px + env(safe-area-inset-left, 0px));
        gap: 12px;
      }

      .topbar{
        padding: 12px;
        gap: 10px;
        grid-template-columns: 1fr;
        align-items:flex-start;
      }
      .topbar-main{
        text-align: right;
      }
      .topbar-left,
      .topbar-right{
        width: 100%;
        justify-content: space-between;
      }
      .topbar-right{
        flex-direction: column;
        align-items: stretch;
      }
      .date-card{
        width: 100%;
      }
      .flip-clock{
        justify-content: center;
      }
      .focus-btn{
        width: 100%;
        justify-content: space-between;
      }

      .views{
        padding: 12px;
      }

      .sidebar{
        height: calc(100vh - 24px);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      .side-top{
        padding: 12px;
        max-height: 180px;
      }
      .brand h1{
        font-size: 18px;
      }
      .badge{
        font-size: 10px;
        padding: 4px 8px;
      }
      .profile{
        margin-top: 10px;
        gap: 8px;
      }
      .avatar{
        width: 40px;
        height: 40px;
        border-radius: 14px;
      }
      .pname{ font-size: 14px; }
      .ptitle{ font-size: 10px; }

      .nav{
        padding: 10px;
        gap: 8px;
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
      }
      .nav button{
        min-height: 56px;
        padding: 10px 12px;
      }
      .nav-ic{
        width: 34px;
        height: 34px;
        border-radius: 14px;
      }
      .nav-ic svg{
        width: 16px;
        height: 16px;
      }
      .nav-title{ font-size: 13px; }
      .nav-hint{ font-size: 11px; }

      .side-bottom{
        padding: 10px 10px 12px;
        gap: 8px;
        margin-top: 0;
      }
      .side-actions-group{
        gap: 6px;
      }
      .side-actions-title{
        font-size: 10px;
      }
      .side-actions{
        gap: 8px;
      }
      .side-actions.primary,
      .side-actions.secondary{
        padding: 8px;
        border-radius: 16px;
      }
      .side-actions .btn{
        min-height: 42px;
        padding: 8px 10px;
        border-radius: 14px;
        gap: 8px;
      }
      .btn-emoji{
        width: 20px;
        height: 20px;
        font-size: 14px;
      }
      .btn-label{
        font-size: 11px;
      }
      .more-toggle{
        min-height: 44px;
        border-radius: 14px;
        font-size: 11px;
      }
      .more-chevron{
        width: 20px;
        height: 20px;
      }
      .more-panel{
        padding: 8px;
        border-radius: 14px;
      }

      .card{
        padding: 12px;
        border-radius: 20px;
      }

      .card-icon{
        width: 32px;
        height: 32px;
        border-radius: 12px;
        font-size: 14px;
      }

      .topbar-title{ font-size: 18px; }
      .topbar-title .title-icon{
        width: 30px;
        height: 30px;
        border-radius: 12px;
      }
      .topbar-title .title-icon svg{
        width: 16px;
        height: 16px;
      }
      .topbar-sub{ font-size: 12px; }
      .kpi{ font-size: 22px; }

      .btn-icon,
      .icon-btn{
        width: 44px;
        height: 44px;
        border-radius: 16px;
      }

      .cal-grid{
        gap: 8px;
        grid-template-columns: repeat(7, minmax(0, 1fr));
      }

      .cal-dow{
        padding: 6px 4px;
        font-size: 11px;
        border-radius: 12px;
      }

      .cal-day{
        min-height: 78px;
        padding: 8px;
        border-radius: 18px;
      }

      .cal-top{ gap: 6px; }
      .cal-num{ font-size: 13px; }
      .cal-badges{ gap: 6px; }

      .mini{
        font-size: 10px;
        padding: 3px 6px;
      }

      .item{
        flex-direction: column;
        align-items: stretch;
      }
      .item-actions{
        width: 100%;
        justify-content: flex-start;
      }
      .item-main{
        min-width: 0;
      }
      .item-meta{
        gap: 6px;
      }
    }

  </style>
</head>

<body>
  <!-- Lock Screen -->
  <div class="lock-screen" id="lockScreen" aria-hidden="true">
    <div class="lock-card">
      <div class="lock-title">PlanOS</div>
      <div class="lock-sub" id="lockSub">برای ورود، پین 4 رقمی را وارد کن</div>

      <div class="pin-row" id="pinRow">
        <input class="pin" inputmode="numeric" pattern="[0-9]*" maxlength="1" data-idx="0" />
        <input class="pin" inputmode="numeric" pattern="[0-9]*" maxlength="1" data-idx="1" />
        <input class="pin" inputmode="numeric" pattern="[0-9]*" maxlength="1" data-idx="2" />
        <input class="pin" inputmode="numeric" pattern="[0-9]*" maxlength="1" data-idx="3" />
      </div>

      <div class="lock-actions">
        <button class="btn btn-primary" id="btnUnlock">ورود</button>
        <button class="btn btn-secondary" id="btnClearPin">پاک کردن</button>
      </div>

      <div class="lock-error" id="lockError"></div>
      <!-- نکته: این قفل «کلاینتی» است (برای استفاده شخصی عالیه، اما امنیت سازمانی نیست). -->
    </div>
  </div>

  <div class="app" id="appRoot">
    <!-- SIDEBAR -->
    <aside class="sidebar glass">
      <div class="side-top">
        <div class="brand">
          <h1>
            <span class="nav-ic" style="width:40px;height:40px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 7.5c0-1.93 1.57-3.5 3.5-3.5h9C18.43 4 20 5.57 20 7.5v9c0 1.93-1.57 3.5-3.5 3.5h-9C5.57 20 4 18.43 4 16.5v-9Z"/>
                <path d="M8 9h8M8 12h8M8 15h5"/>
              </svg>
            </span>
            PlanOS
          </h1>
        </div>
        <div class="profile" id="profileButton" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="dlgProfile">
          <div class="avatar" id="avatar">A</div>
          <div>
            <div class="pname" id="pname">نام شما</div>
            <div class="ptitle" id="ptitle">عنوان شما</div>
          </div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button data-view="dashboard" class="active">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="8" height="8" rx="2"></rect>
                <rect x="13" y="3" width="8" height="8" rx="2"></rect>
                <rect x="3" y="13" width="8" height="8" rx="2"></rect>
                <rect x="13" y="13" width="8" height="8" rx="2"></rect>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">داشبورد</div>
              <div class="nav-hint">نمای کلی + نمودارها</div>
            </div>
          </div>
          <span class="nav-arrow">⌁</span>
        </button>

        <button data-view="planner">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <path d="M22 4 12 14.01l-3-3"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">برنامه روزانه</div>
              <div class="nav-hint">تسک‌ها + تایم‌بلاک</div>
            </div>
          </div>
          <span class="nav-arrow">✓</span>
        </button>

        <button data-view="calendar">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">تقویم (شمسی)</div>
              <div class="nav-hint">ماهانه + کلیک روی روز</div>
            </div>
          </div>
          <span class="nav-arrow">🗓</span>
        </button>

        <button data-view="projects">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 20V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v16"></path>
                <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                <path d="M4 20h16a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-4"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">پروژه‌ها</div>
              <div class="nav-hint">درآمد + وضعیت پروژه</div>
            </div>
          </div>
          <span class="nav-arrow">💼</span>
        </button>

        <button data-view="goals">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="8"></circle>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 2v2M12 20v2M2 12h2M20 12h2"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">اهداف بزرگ</div>
              <div class="nav-hint">مایلستون + پیشرفت</div>
            </div>
          </div>
          <span class="nav-arrow">🎯</span>
        </button>

        <button data-view="finance">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <ellipse cx="12" cy="5" rx="8" ry="3"></ellipse>
                <path d="M4 5v6c0 1.66 3.58 3 8 3s8-1.34 8-3V5"></path>
                <path d="M4 11v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">سرمایه</div>
              <div class="nav-hint">دارایی‌ها + پلن تقسیم</div>
            </div>
          </div>
          <span class="nav-arrow">🪙</span>
        </button>

        <button data-view="notes">
          <div class="nav-left">
            <span class="nav-ic">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5V4.5A2.5 2.5 0 0 1 6.5 2Z"></path>
                <path d="M8 7h8M8 11h8M8 15h5"></path>
              </svg>
            </span>
            <div class="nav-text">
              <div class="nav-title">یادداشت‌ها</div>
              <div class="nav-hint">ژورنال + انگیزشی</div>
            </div>
          </div>
          <span class="nav-arrow">📝</span>
        </button>
      </nav>

      <div class="side-bottom">
        <div class="side-actions-group">
          <div class="side-actions-title">افزودن سریع</div>
          <div class="side-actions primary">
          <button class="btn btn-secondary" id="btnAddTask">
            <span class="btn-emoji">＋</span><span class="btn-label">تسک</span>
          </button>
          <button class="btn btn-secondary" id="btnAddProject">
            <span class="btn-emoji">＋</span><span class="btn-label">پروژه</span>
          </button>
          <button class="btn btn-secondary" id="btnAddGoal">
            <span class="btn-emoji">＋</span><span class="btn-label">هدف</span>
          </button>
          <button class="btn btn-secondary" id="btnAddHolding">
            <span class="btn-emoji">＋</span><span class="btn-label">دارایی</span>
          </button>
          </div>
        </div>
        <div class="more-drawer" id="moreDrawer">
          <button class="btn btn-ghost more-toggle" id="moreToggle" aria-expanded="false" aria-controls="morePanel">
            <span class="more-label">بیشتر</span>
            <span class="more-chevron" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9l6 6 6-6"></path>
              </svg>
            </span>
          </button>
          <div class="more-panel" id="morePanel" aria-hidden="true">
            <div class="more-panel-title">کنترل‌ها</div>
            <div class="side-actions secondary">
              <button class="btn btn-secondary" id="btnLock">
                <span class="btn-emoji">🔒</span><span class="btn-label">قفل</span>
              </button>
              <button class="btn btn-secondary" id="btnTheme">
                <span class="btn-emoji">🌓</span><span class="btn-label">تم</span>
              </button>
              <button class="btn btn-secondary" id="btnExport">
                <span class="btn-emoji">⬇️</span><span class="btn-label">خروجی</span>
              </button>
              <button class="btn btn-secondary" id="btnImport">
                <span class="btn-emoji">⬆️</span><span class="btn-label">ورود</span>
              </button>
              <button class="btn btn-secondary" id="btnRestoreDaily">
                <span class="btn-emoji">🗓️</span><span class="btn-label">بازیابی از بکاپ روزانه</span>
              </button>
              <button class="btn btn-danger" id="btnReset">
                <span class="btn-emoji">⚠️</span><span class="btn-label">ریست</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- CONTENT -->
    <section class="content glass">
      <header class="topbar">
        <div class="topbar-left">
          <div class="date-card" aria-label="تاریخ امروز">
            <div class="date-card-weekday" id="todayWeekday">—</div>
            <div class="date-card-day" id="todayDay">—</div>
            <div class="date-card-footer">
              <span class="date-card-month" id="todayMonth">—</span>
              <span class="date-card-year" id="todayYear">—</span>
            </div>
          </div>
        </div>
        <div class="topbar-main">
          <div class="topbar-title" id="viewTitle">
            <span class="title-icon" id="viewIcon" aria-hidden="true"></span>
            <span class="title-text">داشبورد</span>
          </div>
          <div class="topbar-sub" id="viewSub">نمای کلی پیشرفت، درآمد، سرمایه و اهداف</div>
        </div>
        <div class="topbar-right">
          <div class="flip-clock" id="flipClock" aria-label="زمان فعلی">
            <div class="flip-seg">
              <div class="flip-digit" data-digit="0"><span class="flip-value">0</span></div>
              <div class="flip-digit" data-digit="0"><span class="flip-value">0</span></div>
            </div>
            <span class="flip-colon">:</span>
            <div class="flip-seg">
              <div class="flip-digit" data-digit="0"><span class="flip-value">0</span></div>
              <div class="flip-digit" data-digit="0"><span class="flip-value">0</span></div>
            </div>
          </div>
          <button class="focus-btn" id="btnFocusMode" aria-pressed="false">
            <span class="focus-icon">🎯</span>
            <span class="focus-text">
              <span class="focus-title">حالت تمرکز</span>
              <span class="focus-state" id="focusState">خاموش</span>
            </span>
            <span class="focus-indicator"></span>
          </button>
        </div>
      </header>

      <main class="views">
        <!-- DASHBOARD -->
        <section class="view active focus-scope" id="view-dashboard">
          <div class="grid cols-12">
            <div class="card primary col-4 focus-priority">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📅</span>
                  <h3 class="card-title">پیشرفت امروز</h3>
                </div>
                <span class="chip" id="dashTodayChip">—</span>
              </div>
              <div class="card-body">
                <div class="kpi" id="dashTodayKpi">—</div>
                <div class="muted small" id="dashTodayMeta">—</div>
                <div class="bar"><i id="dashTodayBar"></i></div>
              </div>
            </div>

            <div class="card primary col-4">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">✅</span>
                  <h3 class="card-title">تسک‌های این ماه (شمسی)</h3>
                </div>
                <span class="chip" id="dashMonthChip">—</span>
              </div>
              <div class="card-body">
                <div class="kpi" id="dashMonthKpi">—</div>
                <div class="muted small" id="dashMonthMeta">—</div>
                <div class="bar"><i id="dashMonthBar"></i></div>
              </div>
            </div>

            <div class="card primary col-4">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">💼</span>
                  <h3 class="card-title">درآمد این ماه (شمسی)</h3>
                </div>
                <span class="chip acc">💼</span>
              </div>
              <div class="card-body">
                <div class="kpi" id="dashIncomeKpi">—</div>
                <div class="muted small" id="dashIncomeMeta">—</div>
                <div class="sep"></div>
                <div class="small muted">هدف پس‌انداز ماهانه:</div>
                <div class="row">
                  <span class="chip ok" id="dashSaveTarget">—</span>
                  <span class="muted2 small">نرخ: <span id="dashSaveRate">—</span></span>
                </div>
              </div>
            </div>

            <div class="card secondary col-8">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📊</span>
                  <h3 class="card-title">نمودار 7 روز اخیر (نرخ انجام تسک)</h3>
                </div>
                <span class="badge">Tasks %</span>
              </div>
              <div class="card-body">
                <div style="height: 280px">
                  <canvas id="chartWeek"></canvas>
                  <div class="empty-state" id="chartWeekEmpty" style="display:none;margin-top:12px">
                    <span class="empty-icon">✅</span>
                    <div class="empty-text">
                      <div class="empty-title">هنوز داده‌ای برای این هفته نداریم.</div>
                      <div class="empty-sub">چند تسک برای امروز ثبت کن تا نمودار کامل بشه.</div>
                    </div>
                    <div class="empty-actions">
                      <button class="btn btn-secondary" id="chartWeekCTA">افزودن تسک</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card passive col-4">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">💡</span>
                  <h3 class="card-title">جمله امروز</h3>
                </div>
              </div>
              <div class="card-body">
                <div class="sep"></div>
                <div id="dashMotivation" style="line-height:1.9"></div>
                <div class="sep"></div>
                <button class="btn btn-secondary" id="btnGoNotes">رفتن به یادداشت‌ها</button>
              </div>
            </div>

            <div class="card secondary col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📈</span>
                  <h3 class="card-title">درآمد 6 ماه اخیر (شمسی)</h3>
                </div>
                <span class="badge">Income</span>
              </div>
              <div class="card-body">
                <div style="height: 280px">
                  <canvas id="chartIncome"></canvas>
                  <div class="empty-state" id="chartIncomeEmpty" style="display:none;margin-top:12px">
                    <span class="empty-icon">💼</span>
                    <div class="empty-text">
                      <div class="empty-title">هنوز پروژه‌ای ثبت نشده.</div>
                      <div class="empty-sub">اولین پروژه رو اضافه کن تا روند درآمد شکل بگیره.</div>
                    </div>
                    <div class="empty-actions">
                      <button class="btn btn-secondary" id="chartIncomeCTA">افزودن پروژه</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card secondary col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">🧺</span>
                  <h3 class="card-title">پرتفوی دارایی‌ها</h3>
                </div>
                <span class="badge">Holdings</span>
              </div>
              <div class="card-body">
                <div style="height: 280px">
                  <canvas id="chartPortfolio"></canvas>
                  <div class="empty-state" id="chartPortfolioEmpty" style="display:none;margin-top:12px">
                    <span class="empty-icon">🧺</span>
                    <div class="empty-text">
                      <div class="empty-title">هنوز دارایی ثبت نشده.</div>
                      <div class="empty-sub">دارایی‌هات رو اضافه کن تا ترکیب پرتفوی ببینی.</div>
                    </div>
                    <div class="empty-actions">
                      <button class="btn btn-secondary" id="chartPortfolioCTA">افزودن دارایی</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- PLANNER -->
        <section class="view focus-scope" id="view-planner">
          <div class="grid cols-12">
            <div class="card secondary col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">🗓️</span>
                  <div>
                    <h3 class="card-title">برنامه روزانه</h3>
                    <div class="card-subtitle">تسک اضافه کن، تیک بزن، و گزارش بگیر.</div>
                  </div>
                </div>
                <div class="btn-row" style="align-items:center">
                  <input class="input" type="date" id="plannerDate" style="width: 180px" />
                  <span class="badge" id="plannerJalaliBadge">—</span>
                  <button class="btn btn-primary" id="btnAddTask2">＋ افزودن تسک</button>
                </div>
              </div>

              <div class="card-body">
                <div class="sep"></div>

                <div class="form-grid">
                  <div class="full">
                    <label>افزودن سریع</label>
                    <div class="row" style="gap:10px; align-items:stretch">
                      <input class="input" id="quickTaskTitle" placeholder="مثلاً: 45 دقیقه تمرین طراحی / پیام به مشتری / مطالعه..." />
                      <button class="btn btn-secondary nowrap" id="btnQuickAdd">افزودن</button>
                    </div>
                    <div class="row" style="margin-top:10px">
                      <div class="chips">
                        <span class="chip">تعداد: <b id="plannerCount">0</b></span>
                        <span class="chip ok">انجام‌شده: <b id="plannerDone">0</b></span>
                        <span class="chip acc">پیشرفت: <b id="plannerRate">0%</b></span>
                      </div>
                      <div style="width: min(420px, 100%); margin-top:8px">
                        <div class="bar"><i id="plannerBar"></i></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card secondary col-12 focus-priority">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📋</span>
                  <h3 class="card-title">لیست تسک‌های این روز</h3>
                </div>
                <div class="chips">
                  <span class="chip">فیلتر:</span>
                  <button class="btn btn-ghost" id="toggleShowDone">نمایش انجام‌شده‌ها: <b id="showDoneState">روشن</b></button>
                </div>
              </div>
              <div class="card-body">
                <div class="sep"></div>
                <div class="list" id="plannerList"></div>
                <div class="empty-state" id="plannerEmpty" style="display:none">
                  <span class="empty-icon">📋</span>
                  <div class="empty-text">
                    <div class="empty-title">برای امروز تسکی نداری.</div>
                    <div class="empty-sub">با یک تسک کوچیک شروع کن تا تمرکزت برگرده.</div>
                  </div>
                  <div class="empty-actions">
                    <button class="btn btn-secondary" id="btnPlannerEmptyAdd">افزودن تسک</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CALENDAR -->
        <section class="view" id="view-calendar">
          <div class="card secondary">
            <div class="card-header">
              <div class="card-title-group">
                <span class="card-icon">🗓️</span>
                <div>
                  <h3 class="card-title">تقویم ماهانه (شمسی)</h3>
                  <div class="card-subtitle">روی هر روز کلیک کن تا برنامه همون روز باز شه.</div>
                </div>
              </div>
              <div class="btn-row">
                <button class="btn btn-secondary" id="btnPrevMonth">◀ ماه قبل</button>
                <span class="badge" id="calMonthLabel">—</span>
                <button class="btn btn-secondary" id="btnNextMonth">ماه بعد ▶</button>
              </div>
            </div>

            <div class="card-body">
              <div class="cal-grid" id="calDow"></div>
              <div style="height:10px"></div>
              <div class="cal-grid" id="calGrid"></div>
            </div>
          </div>
        </section>

        <!-- PROJECTS -->
        <section class="view" id="view-projects">
          <div class="grid cols-12">
            <div class="card secondary col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📁</span>
                  <div>
                    <h3 class="card-title">پروژه‌ها</h3>
                    <div class="card-subtitle">ثبت پروژه، مبلغ، وضعیت و یادداشت‌ها.</div>
                  </div>
                </div>
                <div class="btn-row">
                  <button class="btn btn-primary" id="btnAddProject2">＋ افزودن پروژه</button>
                  <select id="projectFilter" style="width: 180px">
                    <option value="all">همه وضعیت‌ها</option>
                    <option value="todo">در انتظار</option>
                    <option value="doing">در حال انجام</option>
                    <option value="done">انجام‌شده</option>
                  </select>
                </div>
              </div>
              <div class="card-body">
                <div class="sep"></div>
                <div class="chips">
                  <span class="chip">این ماه (شمسی): <b id="projMonthCount">0</b> پروژه</span>
                  <span class="chip acc">درآمد این ماه: <b id="projMonthIncome">0</b></span>
                </div>
              </div>
            </div>

            <div class="card secondary col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📊</span>
                  <h3 class="card-title">لیست پروژه‌ها</h3>
                </div>
              </div>
              <div class="card-body">
                <table>
                  <thead>
                    <tr>
                      <th>عنوان</th>
                      <th>مشتری</th>
                      <th>مبلغ</th>
                      <th>تاریخ (شمسی)</th>
                      <th>وضعیت</th>
                      <th>عملیات</th>
                    </tr>
                  </thead>
                  <tbody id="projectTbody"></tbody>
                </table>
                <div class="muted small" id="projectsEmpty" style="display:none">هنوز پروژه‌ای ثبت نشده.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- GOALS -->
        <section class="view" id="view-goals">
          <div class="grid cols-12">
            <div class="card secondary col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">🎯</span>
                  <div>
                    <h3 class="card-title">اهداف بزرگ</h3>
                    <div class="card-subtitle">هدف + مایلستون + درصد پیشرفت.</div>
                  </div>
                </div>
                <button class="btn btn-primary" id="btnAddGoal2">＋ افزودن هدف</button>
              </div>
            </div>

            <div class="col-12 list" id="goalsList"></div>
            <div class="muted small" id="goalsEmpty" style="display:none">هنوز هدفی ثبت نشده.</div>
          </div>
        </section>

        <!-- FINANCE -->
        <section class="view" id="view-finance">
          <div class="grid cols-12">
            <div class="card secondary col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">💰</span>
                  <div>
                    <h3 class="card-title">دارایی‌ها</h3>
                    <div class="card-subtitle">طلا/نقره/کریپتو/نقد… هر چیزی رو ثبت کن.</div>
                  </div>
                </div>
                <button class="btn btn-primary" id="btnAddHolding2">＋ دارایی</button>
              </div>
              <div class="card-body">
                <div class="sep"></div>
                <div class="muted2 small">پیشنهاد: هر هفته/ماه آپدیت کن تا نمودارها معنی‌دار بشن.</div>
                <div style="height:10px"></div>
                <table>
                  <thead>
                    <tr>
                      <th>نوع</th>
                      <th>مقدار</th>
                      <th>واحد</th>
                      <th>عملیات</th>
                    </tr>
                  </thead>
                  <tbody id="holdingsTbody"></tbody>
                </table>
                <div class="muted small" id="holdingsEmpty" style="display:none">هنوز دارایی ثبت نشده.</div>
              </div>
            </div>

            <div class="card secondary col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">🧭</span>
                  <div>
                    <h3 class="card-title">پلن سرمایه‌گذاری</h3>
                    <div class="card-subtitle">درصدها رو استاندارد نگه دار.</div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="sep"></div>

                <label>حداقل درآمد ماهانه</label>
                <input class="input" type="number" id="monthlyMinIncome" />

                <label>نرخ پس‌انداز هدف (مثلاً 0.3 یعنی 30%)</label>
                <input class="input" type="number" step="0.01" id="savingsRateTarget" />

                <div class="sep"></div>
                <div class="row">
                  <h3 class="card-title">تقسیم سرمایه‌گذاری</h3>
                  <button class="btn btn-secondary" id="btnNormalizeSplit">نرمال‌سازی به 100%</button>
                </div>

                <div class="form-grid" style="margin-top:10px">
                  <div>
                    <label>طلا (%)</label>
                    <input class="input" type="number" id="splitGold" />
                  </div>
                  <div>
                    <label>کریپتو (%)</label>
                    <input class="input" type="number" id="splitCrypto" />
                  </div>
                  <div>
                    <label>نقره (%)</label>
                    <input class="input" type="number" id="splitSilver" />
                  </div>
                  <div>
                    <label>نقد/تتر آزاد (%)</label>
                    <input class="input" type="number" id="splitCash" />
                  </div>
                  <div class="full">
                    <div class="chips">
                      <span class="chip">جمع: <b id="splitSum">100%</b></span>
                      <span class="chip warn" id="splitWarn" style="display:none">جمع درصدها باید 100% باشد.</span>
                    </div>
                  </div>
                </div>

                <div class="sep"></div>
                <h3 class="card-title">پیشنهاد خروجی ماهانه</h3>
                <div class="muted small">براساس حداقل درآمد و نرخ پس‌انداز.</div>
                <div class="sep"></div>
                <div class="chips" id="financeSuggestions"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- NOTES -->
        <section class="view" id="view-notes">
          <div class="grid cols-12">
            <div class="card secondary col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📝</span>
                  <div>
                    <h3 class="card-title">یادداشت‌ها و ژورنال</h3>
                    <div class="card-subtitle">هر چی مهمه ثبت کن (Auto Save).</div>
                  </div>
                </div>
                <span class="badge">Auto Save</span>
              </div>
            </div>

            <div class="card secondary col-12" id="notesEmpty" style="display:none">
              <div class="empty-state">
                <span class="empty-icon">📝</span>
                <div class="empty-text">
                  <div class="empty-title">دفتر امروزت خالیه.</div>
                  <div class="empty-sub">چند جمله کوتاه بنویس تا ذهنت سبک‌تر بشه.</div>
                </div>
                <div class="empty-actions">
                  <button class="btn btn-secondary" id="btnStartNotes">شروع نوشتن</button>
                </div>
              </div>
            </div>

            <div class="card passive col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📌</span>
                  <h3 class="card-title">برنامه/نیت روزانه</h3>
                </div>
              </div>
              <div class="card-body">
                <label>چی امروز مهمه؟</label>
                <textarea id="noteDaily" placeholder="امروز 2 کار اصلی..."></textarea>
              </div>
            </div>

            <div class="card passive col-6">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">✨</span>
                  <h3 class="card-title">جمله انگیزشی</h3>
                </div>
              </div>
              <div class="card-body">
                <label>جمله کوتاه روز</label>
                <textarea id="noteMotivation" placeholder="تمرکز روی سیستم، نه هیجان."></textarea>
              </div>
            </div>

            <div class="card passive col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">📓</span>
                  <h3 class="card-title">ژورنال</h3>
                </div>
              </div>
              <div class="card-body">
                <label>ثبت اتفاقات، درس‌ها، احساسات</label>
                <textarea id="noteJournal" placeholder="امروز چی یاد گرفتم؟"></textarea>
              </div>
            </div>

            <div class="card passive col-12">
              <div class="card-header">
                <div class="card-title-group">
                  <span class="card-icon">💭</span>
                  <h3 class="card-title">ایده‌ها</h3>
                </div>
              </div>
              <div class="card-body">
                <label>ایده‌های پروژه/محصول/یادگیری</label>
                <textarea id="noteIdeas" placeholder="ایده: ..."></textarea>
              </div>
            </div>
          </div>
        </section>
      </main>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <!-- DIALOGS -->
  <div id="modalRoot">
  <dialog id="dlgTask" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title" id="dlgTaskTitle">افزودن تسک</div>
          <div class="dlg-sub">تسک، تاریخ، اولویت و تایم‌بلاک را مشخص کن.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgTask" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <div class="form-grid">
          <div class="full">
            <label>عنوان</label>
            <input class="input" id="taskTitle" placeholder="مثلاً: 45 دقیقه تمرین UI" />
          </div>

          <div>
            <label>تاریخ (میلادی - برای ذخیره)</label>
            <input class="input" type="date" id="taskDate" />
            <div class="muted2 small" id="taskDateJ" style="margin-top:6px">—</div>
          </div>

          <div>
            <label>اولویت</label>
            <select class="input" id="taskPriority">
              <option value="low">کم</option>
              <option value="medium" selected>متوسط</option>
              <option value="high">زیاد</option>
            </select>
          </div>

          <div>
            <label>دسته‌بندی</label>
            <input class="input" id="taskCategory" placeholder="کار / درس / مهارت / سلامتی ..." />
          </div>

          <div>
            <label>تایم‌بلاک</label>
            <select class="input" id="taskTimeBlock">
              <option value="صبح">صبح</option>
              <option value="ظهر">ظهر</option>
              <option value="عصر">عصر</option>
              <option value="شب">شب</option>
            </select>
          </div>

          <div class="full">
            <label>تخمین زمان (دقیقه)</label>
            <input class="input" type="number" id="taskEstimate" min="0" step="5" value="30" />
          </div>

          <div class="full">
            <label>
              <input type="checkbox" id="taskDone" />
              انجام شده
            </label>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn btn-danger" id="btnTaskDelete" style="visibility:hidden">حذف</button>
        <div class="btn-row">
          <button class="btn btn-secondary" data-close="dlgTask">انصراف</button>
          <button class="btn btn-primary" id="btnTaskSave">ذخیره</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="dlgProfile" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title">ویرایش پروفایل</div>
          <div class="dlg-sub">نام، عنوان و آواتار را تغییر بده.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgProfile" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <div class="form-grid">
          <div class="full">
            <label>نام</label>
            <input class="input" id="profileName" placeholder="نام شما" />
          </div>
          <div class="full">
            <label>عنوان/شغل</label>
            <input class="input" id="profileTitle" placeholder="عنوان شما" />
          </div>
          <div class="full">
            <label>آپلود آواتار</label>
            <input class="input" type="file" id="profileAvatar" accept="image/*" />
          </div>
          <div class="full">
            <label>پین قفل (4 رقم)</label>
            <input class="input" id="profilePin" type="password" inputmode="numeric" maxlength="4" placeholder="مثلاً 1234" />
            <!-- PIN به صورت امن (هش) ذخیره می‌شود. -->
          </div>
          <div class="full">
            <button class="btn btn-danger" id="btnRemoveAvatar">حذف آواتار</button>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <div></div>
        <div class="btn-row">
          <button class="btn btn-secondary" data-close="dlgProfile">انصراف</button>
          <button class="btn btn-primary" id="btnProfileSave">ذخیره</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="dlgProject" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title" id="dlgProjectTitle">افزودن پروژه</div>
          <div class="dlg-sub">ثبت پروژه‌ها باعث میشه درآمد و رشد واقعی‌ت مشخص بشه.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgProject" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <div class="form-grid">
          <div class="full">
            <label>عنوان پروژه</label>
            <input class="input" id="projName" placeholder="مثلاً: طراحی لوگو / UI سایت ..." />
          </div>
          <div>
            <label>مشتری</label>
            <input class="input" id="projClient" placeholder="نام مشتری/برند" />
          </div>
          <div>
            <label>مبلغ</label>
            <input class="input" type="number" id="projAmount" placeholder="مثلاً 6500000" />
          </div>
          <div>
            <label>تاریخ (میلادی - برای ذخیره)</label>
            <input class="input" type="date" id="projDate" />
            <div class="muted2 small" id="projDateJ" style="margin-top:6px">—</div>
          </div>
          <div>
            <label>وضعیت</label>
            <select class="input" id="projStatus">
              <option value="todo">در انتظار</option>
              <option value="doing">در حال انجام</option>
              <option value="done">انجام‌شده</option>
            </select>
          </div>
          <div>
            <label>تگ‌ها (با کاما جدا کن)</label>
            <input class="input" id="projTags" placeholder="مثلاً: برندینگ, UI, لوگو" />
          </div>
          <div class="full">
            <label>یادداشت</label>
            <textarea id="projNotes" placeholder="نکات تحویل، فیدبک مشتری، لینک‌ها..."></textarea>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn btn-danger" id="btnProjectDelete" style="visibility:hidden">حذف</button>
        <div class="btn-row">
          <button class="btn btn-secondary" data-close="dlgProject">انصراف</button>
          <button class="btn btn-primary" id="btnProjectSave">ذخیره</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="dlgGoal" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title" id="dlgGoalTitle">افزودن هدف</div>
          <div class="dlg-sub">هدف بزرگ = مسیر روشن. مایلستون‌ها = حرکت واقعی.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgGoal" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <div class="form-grid">
          <div class="full">
            <label>عنوان هدف</label>
            <input class="input" id="goalTitle" placeholder="مثلاً: رسیدن به 40 میلیون درآمد ماهانه" />
          </div>
          <div>
            <label>افق زمانی</label>
            <input class="input" id="goalHorizon" placeholder="مثلاً: 3 ماه / 6 ماه" />
          </div>
          <div>
            <label>متریک</label>
            <input class="input" id="goalMetric" placeholder="مثلاً: درآمد / وزن / ساعت مطالعه ..." />
          </div>
          <div>
            <label>هدف (Target)</label>
            <input class="input" type="number" id="goalTarget" />
          </div>
          <div>
            <label>مقدار فعلی (Current)</label>
            <input class="input" type="number" id="goalCurrent" />
          </div>
          <div class="full">
            <label>مایلستون‌ها (هر خط یک مورد)</label>
            <textarea id="goalMilestones" placeholder="مثلاً:
پورتفولیو جدید
3 کیس‌استادی کامل
افزایش قیمت‌گذاری"></textarea>
          </div>
          <div class="full">
            <label>یادداشت</label>
            <textarea id="goalNotes" placeholder="توضیح مسیر، برنامه، دلیل، منابع..."></textarea>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn btn-danger" id="btnGoalDelete" style="visibility:hidden">حذف</button>
        <div class="btn-row">
          <button class="btn btn-secondary" data-close="dlgGoal">انصراف</button>
          <button class="btn btn-primary" id="btnGoalSave">ذخیره</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="dlgHolding" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title" id="dlgHoldingTitle">افزودن دارایی</div>
          <div class="dlg-sub">دارایی‌ها رو دقیق ثبت کن تا پرتفوی معنی‌دار بشه.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgHolding" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <div class="form-grid">
          <div>
            <label>نوع</label>
            <input class="input" id="holdType" placeholder="طلا / نقره / XRP / ETH ..." />
          </div>
          <div>
            <label>واحد</label>
            <input class="input" id="holdUnit" placeholder="تومان / گرم / USDT / USD ..." />
          </div>
          <div class="full">
            <label>مقدار</label>
            <input class="input" type="number" id="holdAmount" />
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn btn-danger" id="btnHoldingDelete" style="visibility:hidden">حذف</button>
        <div class="btn-row">
          <button class="btn btn-secondary" data-close="dlgHolding">انصراف</button>
          <button class="btn btn-primary" id="btnHoldingSave">ذخیره</button>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="dlgImport" class="modal-overlay">
    <div class="modal-card">
      <div class="dlg-head">
        <div>
          <div class="dlg-title">ورود داده (Import)</div>
          <div class="dlg-sub">فایل JSON خروجی رو وارد کن.</div>
        </div>
        <button class="btn btn-icon" data-close="dlgImport" title="بستن">✕</button>
      </div>
      <div class="dlg-body">
        <label>فایل خروجی (JSON)</label>
        <input class="input" type="file" id="importFile" accept=".json,application/json" />
        <div class="sep"></div>
        <div class="muted small">
          هشدار: Import داده‌های فعلی را جایگزین می‌کند. قبلش Export بگیر.
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn btn-secondary" data-close="dlgImport">انصراف</button>
        <button class="btn btn-primary" id="btnImportDo">وارد کردن</button>
      </div>
    </div>
  </dialog>
  </div>

<script>
(() => {
  // =========================
  // PWA Service Worker
  // =========================
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
  }

  // =========================
  // Jalali (Shamsi) Conversion
  // Based on jalaali-js algorithm (MIT).
  // =========================
  function div(a, b) { return ~~(a / b); }
  function mod(a, b) { return a - ~~(a / b) * b; }

  const breaks = [-61, 9, 38, 199, 426, 686, 756, 818, 1111, 1181, 1210, 1635, 2060, 2097, 2192, 2262, 2324, 2394, 2456, 3178];

  function jalCal(jy) {
    let bl = breaks.length,
        gy = jy + 621,
        leapJ = -14,
        jp = breaks[0],
        jm,
        jump,
        leap,
        leapG,
        march,
        n,
        i;

    if (jy < jp || jy >= breaks[bl - 1])
      throw new Error('Invalid Jalali year ' + jy);

    for (i = 1; i < bl; i += 1) {
      jm = breaks[i];
      jump = jm - jp;
      if (jy < jm)
        break;
      leapJ = leapJ + div(jump, 33) * 8 + div(mod(jump, 33), 4);
      jp = jm;
    }
    n = jy - jp;

    leapJ = leapJ + div(n, 33) * 8 + div(mod(n, 33) + 3, 4);
    if (mod(jump, 33) === 4 && jump - n === 4)
      leapJ += 1;

    leapG = div(gy, 4) - div((div(gy, 100) + 1) * 3, 4) - 150;
    march = 20 + leapJ - leapG;

    if (jump - n < 6)
      n = n - jump + div(jump + 4, 33) * 33;
    leap = mod(mod(n + 1, 33) - 1, 4);
    if (leap === -1) {
      leap = 4;
    }

    return { leap: leap, gy: gy, march: march };
  }

  function isLeapJalaaliYear(jy) { return jalCal(jy).leap === 0; }

  function jalaaliMonthLength(jy, jm) {
    if (jm <= 6) return 31;
    if (jm <= 11) return 30;
    return isLeapJalaaliYear(jy) ? 30 : 29;
  }

  function g2d(gy, gm, gd) {
    let d = div((gy + div(gm - 8, 6) + 100100) * 1461, 4)
      + div(153 * mod(gm + 9, 12) + 2, 5)
      + gd - 34840408;
    d = d - div(div(gy + 100100 + div(gm - 8, 6), 100) * 3, 4) + 752;
    return d;
  }

  function d2g(jdn) {
    let j = 4 * jdn + 139361631;
    j = j + div(div(4 * jdn + 183187720, 146097) * 3, 4) * 4 - 3908;
    let i = div(mod(j, 1461), 4) * 5 + 308;
    let gd = div(mod(i, 153), 5) + 1;
    let gm = mod(div(i, 153), 12) + 1;
    let gy = div(j, 1461) - 100100 + div(8 - gm, 6);
    return { gy: gy, gm: gm, gd: gd };
  }

  function j2d(jy, jm, jd) {
    let r = jalCal(jy);
    return g2d(r.gy, 3, r.march) + (jm - 1) * 31 - div(jm, 7) * (jm - 7) + jd - 1;
  }

  function d2j(jdn) {
    let g = d2g(jdn),
        gy = g.gy,
        gm = g.gm,
        gd = g.gd,
        jy = gy - 621,
        r = jalCal(jy),
        jdn1f = g2d(gy, 3, r.march),
        jd,
        jm,
        k;

    k = jdn - jdn1f;
    if (k >= 0) {
      if (k <= 185) {
        jm = 1 + div(k, 31);
        jd = mod(k, 31) + 1;
        return { jy: jy, jm: jm, jd: jd };
      } else {
        k -= 186;
      }
    } else {
      jy -= 1;
      k += 179;
      if (r.leap === 1)
        k += 1;
    }
    jm = 7 + div(k, 30);
    jd = mod(k, 30) + 1;
    return { jy: jy, jm: jm, jd: jd };
  }

  function toJalaali(gy, gm, gd) { return d2j(g2d(gy, gm, gd)); }
  function toGregorian(jy, jm, jd) { return d2g(j2d(jy, jm, jd)); }

  const J_MONTHS = ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];
  const FA_DIGITS = "۰۱۲۳۴۵۶۷۸۹";
  const toEnglishDigits = (input) => {
    if (input == null) return "";
    return input.toString().replace(/[۰-۹]/g, d => FA_DIGITS.indexOf(d));
  };
  const pad2 = (n) => (n < 10 ? "0" + n : "" + n);
  const isoToParts = (iso) => {
    const [y,m,d] = String(iso).split("-").map(Number);
    return { y, m, d };
  };
  const isoToJalali = (iso) => {
    const p = isoToParts(iso);
    return toJalaali(p.y, p.m, p.d);
  };
  const jalaliToISO = (jy, jm, jd) => {
    const g = toGregorian(jy, jm, jd);
    return `${g.gy}-${pad2(g.gm)}-${pad2(g.gd)}`;
  };
  const jalaliDateStr = (jy, jm, jd) => toEnglishDigits(`${jy}/${pad2(jm)}/${pad2(jd)}`);
  const isoToJalaliStr = (iso) => {
    const j = isoToJalali(iso);
    return jalaliDateStr(j.jy, j.jm, j.jd);
  };
  const jalaliMonthLabel = (jy, jm) => `${J_MONTHS[jm-1]} ${toEnglishDigits(jy)}`;

  const shiftJalaliMonth = (jy, jm, delta) => {
    let y = jy, m = jm + delta;
    while (m > 12) { m -= 12; y += 1; }
    while (m < 1) { m += 12; y -= 1; }
    return { jy: y, jm: m };
  };

  const jalaliMonthRangeISO = (jy, jm) => {
    const start = toGregorian(jy, jm, 1);
    const endDay = jalaaliMonthLength(jy, jm);
    const end = toGregorian(jy, jm, endDay);
    const s = `${start.gy}-${pad2(start.gm)}-${pad2(start.gd)}`;
    const e = `${end.gy}-${pad2(end.gm)}-${pad2(end.gd)}`;
    return { s, e };
  };

  // =========================
  // Storage & Helpers
  // =========================
  const STORAGE_KEY = "planos_v1"; // keep stable
  const LOCK_SESSION_KEY = "planos_unlocked";

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)");
  const uid = () => (Math.random().toString(36).slice(2, 10) + "_" + Date.now().toString(36));
  const todayISO = () => {
    const d = new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
  };
  const moneyFA = (n) => toEnglishDigits(Number(n||0).toLocaleString("fa-IR"));
  const safeParse = (raw) => { try { return JSON.parse(raw); } catch { return null; } };

  const defaultState = () => {
    return {
      meta: { version: 3, createdAt: new Date().toISOString() },
      profile: {
        name: "",
        title: "",
        avatarData: "",
        monthlyMinIncome: 0,
        savingsRateTarget: 0,
        currency: "تومان"
      },
      settings: { theme: "light", rtl: true, focusMode: false, pinHash: "", pinSalt: "" },
      notes: {
        daily: "",
        motivation: "",
        journal: "",
        ideas: ""
      },
      tasks: [],
      projects: [],
      goals: [],
      assets: {
        holdings: [],
        plan: { split: { gold: 0, crypto: 0, silver: 0, cash: 0 } }
      }
    };
  };

  const loadState = () => {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? safeParse(raw) : null;
    return parsed && parsed.meta ? parsed : null;
  };
  const BACKUP_DB_NAME = "planos_backup_db";
  const BACKUP_STORE = "backups";
  const BACKUP_RETENTION = 7;
  const BACKUP_DEBOUNCE_MS = 30000;
  let backupTimer = null;

  const openBackupDB = () => new Promise((resolve, reject) => {
    const request = indexedDB.open(BACKUP_DB_NAME, 1);
    request.onupgradeneeded = () => {
      const db = request.result;
      if (!db.objectStoreNames.contains(BACKUP_STORE)) {
        db.createObjectStore(BACKUP_STORE, { keyPath: "dateKey" });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });

  const buildDateKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const saveDailyBackup = async (stateObject) => {
    const db = await openBackupDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(BACKUP_STORE, "readwrite");
      const store = tx.objectStore(BACKUP_STORE);
      const dateKey = buildDateKey();
      store.put({ dateKey, createdAt: new Date().toISOString(), data: stateObject });
      const getAllReq = store.getAll();
      getAllReq.onsuccess = () => {
        const items = getAllReq.result || [];
        if (items.length > BACKUP_RETENTION) {
          items.sort((a, b) => String(b.dateKey).localeCompare(String(a.dateKey)));
          const stale = items.slice(BACKUP_RETENTION);
          stale.forEach((item) => store.delete(item.dateKey));
        }
      };
      tx.oncomplete = () => {
        db.close();
        resolve();
      };
      tx.onerror = () => {
        db.close();
        reject(tx.error);
      };
      tx.onabort = () => {
        db.close();
        reject(tx.error);
      };
    });
  };

  const scheduleDailyBackup = (stateObject) => {
    if (!("indexedDB" in window)) return;
    if (backupTimer) clearTimeout(backupTimer);
    backupTimer = setTimeout(async () => {
      backupTimer = null;
      try {
        await saveDailyBackup(stateObject);
      } catch {
        // ignore backup failures (fallback storage)
      }
    }, BACKUP_DEBOUNCE_MS);
  };

  const listDailyBackups = async () => {
    const db = await openBackupDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(BACKUP_STORE, "readonly");
      const store = tx.objectStore(BACKUP_STORE);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
      tx.oncomplete = () => db.close();
      tx.onerror = () => {
        db.close();
        reject(tx.error);
      };
    });
  };

  const isValidBackupState = (data) => {
    if (!data || typeof data !== "object") return false;
    const requiredKeys = ["meta", "profile", "settings", "notes", "tasks", "projects", "goals", "assets"];
    if (!requiredKeys.every((key) => key in data)) return false;
    if (!Array.isArray(data.tasks) || !Array.isArray(data.projects) || !Array.isArray(data.goals)) return false;
    if (typeof data.meta !== "object" || typeof data.profile !== "object") return false;
    if (typeof data.settings !== "object" || typeof data.notes !== "object") return false;
    if (typeof data.assets !== "object") return false;
    return true;
  };
  let state = loadState() || defaultState();
  state.profile.avatarData = state.profile.avatarData || "";
  state.settings = { theme: "light", rtl: true, focusMode: false, pinHash: "", pinSalt: "", ...state.settings };
  state.settings.focusMode = !!state.settings.focusMode;
  const normalizePin = (val) => String(val || "").replace(/\D/g, "").slice(0,4);
  const hasWebCrypto = () => !!(window.crypto && window.crypto.subtle && window.crypto.getRandomValues);
  const toHex = (buffer) => Array.from(new Uint8Array(buffer)).map((b) => b.toString(16).padStart(2, "0")).join("");
  const generateSalt = () => {
    const bytes = new Uint8Array(16);
    window.crypto.getRandomValues(bytes);
    return toHex(bytes);
  };
  const hashPin = async (pin, salt) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(`${salt}:${pin}`);
    const digest = await window.crypto.subtle.digest("SHA-256", data);
    return toHex(digest);
  };
  const hasPinSet = () => !!(state.settings.pinHash && state.settings.pinSalt);
  const saveState = () => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    scheduleDailyBackup(state);
  };

  const toast = (msg) => {
    const el = $("#toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(el._t);
    el._t = setTimeout(() => el.style.display = "none", 2200);
  };

  const migrateLegacyPin = async () => {
    if (hasPinSet()) {
      let didChange = false;
      if ("pin" in state.settings) {
        delete state.settings.pin;
        didChange = true;
      }
      if (localStorage.getItem("pin")) localStorage.removeItem("pin");
      if (didChange) saveState();
      return;
    }
    const legacyPinRaw = state.settings.pin || localStorage.getItem("pin") || "";
    const legacyPin = normalizePin(legacyPinRaw);
    if (!legacyPin || legacyPin.length !== 4) {
      let didChange = false;
      if ("pin" in state.settings) {
        delete state.settings.pin;
        didChange = true;
      }
      if (localStorage.getItem("pin")) localStorage.removeItem("pin");
      if (didChange) saveState();
      return;
    }
    if (!hasWebCrypto()) {
      toast("مرورگر از ذخیره امن پین پشتیبانی نمی‌کند.");
      return;
    }
    const salt = generateSalt();
    const hash = await hashPin(legacyPin, salt);
    state.settings.pinSalt = salt;
    state.settings.pinHash = hash;
    if ("pin" in state.settings) delete state.settings.pin;
    if (localStorage.getItem("pin")) localStorage.removeItem("pin");
    saveState();
  };

  // =========================
  // PIN Lock
  // =========================
  const updateLockAvailability = () => {
    const hasPin = hasPinSet();
    const btnLock = $("#btnLock");
    if (btnLock) {
      btnLock.disabled = !hasPin;
      btnLock.classList.toggle("is-disabled", !hasPin);
      btnLock.title = hasPin ? "قفل" : "پین تنظیم نشده است";
    }
    const lockSub = $("#lockSub");
    if (lockSub) {
      lockSub.textContent = hasPin
        ? "برای ورود، پین 4 رقمی را وارد کن"
        : "برای فعال‌سازی قفل، پین 4 رقمی را در پروفایل تنظیم کن.";
    }
    return hasPin;
  };

  const showLock = () => {
    if (!updateLockAvailability()) {
      hideLock();
      return;
    }
    const lock = $("#lockScreen");
    lock.style.display = "flex";
    lock.setAttribute("aria-hidden", "false");
    $("#lockError").textContent = "";
    clearPinInputs();
    setTimeout(() => pinInputs()[0]?.focus(), 50);
  };
  const hideLock = () => {
    const lock = $("#lockScreen");
    lock.style.display = "none";
    lock.setAttribute("aria-hidden", "true");
  };

  const pinInputs = () => $$(".pin", $("#pinRow"));
  const clearPinInputs = () => pinInputs().forEach(i => i.value = "");
  const getPinValue = () => pinInputs().map(i => i.value).join("");

  const tryUnlock = async () => {
    if (!hasPinSet()) {
      $("#lockError").textContent = "پین هنوز تنظیم نشده است.";
      return;
    }
    if (!hasWebCrypto()) {
      $("#lockError").textContent = "مرورگر از رمزنگاری امن پشتیبانی نمی‌کند.";
      return;
    }
    const val = getPinValue();
    if (val.length < 4) {
      $("#lockError").textContent = "پین باید 4 رقم باشد.";
      return;
    }
    try {
      const hashed = await hashPin(val, state.settings.pinSalt);
      if (hashed === state.settings.pinHash) {
        sessionStorage.setItem(LOCK_SESSION_KEY, "1");
        hideLock();
        toast("خوش اومدی ✅");
        return;
      }
    } catch {
      $("#lockError").textContent = "خطا در بررسی پین.";
      return;
    }
    $("#lockError").textContent = "پین اشتباه است.";
    clearPinInputs();
    pinInputs()[0]?.focus();
  };

  const initLock = () => {
    // init inputs behavior
    const inputs = pinInputs();

    inputs.forEach((inp, idx) => {
      inp.addEventListener("input", (e) => {
        const v = (inp.value || "").replace(/\D/g, "");
        inp.value = v.slice(0,1);
        if (inp.value && idx < inputs.length - 1) inputs[idx+1].focus();
        if (getPinValue().length === 4) void tryUnlock();
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !inp.value && idx > 0) {
          inputs[idx-1].focus();
        }
        if (e.key === "Enter") {
          e.preventDefault();
          void tryUnlock();
        }
      });

      inp.addEventListener("paste", (e) => {
        const text = (e.clipboardData || window.clipboardData).getData("text");
        if (!text) return;
        const digits = text.replace(/\D/g, "").slice(0,4).split("");
        if (digits.length) {
          e.preventDefault();
          clearPinInputs();
          digits.forEach((d, i) => { if (inputs[i]) inputs[i].value = d; });
          if (digits.length === 4) void tryUnlock();
          else inputs[Math.min(digits.length, 3)].focus();
        }
      });
    });

    $("#btnUnlock").addEventListener("click", () => void tryUnlock());
    $("#btnClearPin").addEventListener("click", () => { clearPinInputs(); $("#lockError").textContent = ""; pinInputs()[0]?.focus(); });
    $("#btnLock").addEventListener("click", () => {
      if (!updateLockAvailability()) {
        toast("ابتدا پین را در پروفایل تنظیم کن.");
        openProfileDialog();
        return;
      }
      sessionStorage.removeItem(LOCK_SESSION_KEY);
      showLock();
    });

    const hasPin = updateLockAvailability();
    const unlocked = sessionStorage.getItem(LOCK_SESSION_KEY) === "1";
    if (!hasPin || unlocked) {
      hideLock();
    } else {
      showLock();
    }
  };

  // =========================
  // Date & Week helpers
  // =========================
  const getFaWeekdayIndex = (date) => {
    // JS: 0 Sun..6 Sat -> Persian week index: Sat=0..Fri=6
    const js = new Date(date).getDay();
    return (js + 1) % 7;
  };
  const faDow = ["شنبه","یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنجشنبه","جمعه"];
  const USE_12H_CLOCK = false;

  // =========================
  // Navigation
  // =========================
  const viewMeta = {
    dashboard: { title: "داشبورد", sub: "نمای کلی پیشرفت، درآمد، سرمایه و اهداف" },
    planner:   { title: "برنامه روزانه", sub: "مدیریت تسک‌ها با تاریخ و اولویت و تایم‌بلاک" },
    calendar:  { title: "تقویم (شمسی)", sub: "نمای ماهانه شمسی + کلیک روی روز برای رفتن به برنامه" },
    projects:  { title: "پروژه‌ها", sub: "ثبت پروژه‌ها و درآمد و وضعیت پیشرفت" },
    goals:     { title: "اهداف بزرگ", sub: "اهداف + مایلستون‌ها + درصد پیشرفت" },
    finance:   { title: "سرمایه", sub: "دارایی‌ها + پلن تقسیم سرمایه‌گذاری" },
    notes:     { title: "یادداشت‌ها", sub: "ژورنال + جمله انگیزشی + ایده‌ها" }
  };

  const updateViewIcon = (name) => {
    const iconHolder = $("#viewIcon");
    if (!iconHolder) return;
    const navIcon = document.querySelector(`#nav button[data-view="${name}"] .nav-ic`);
    if (!navIcon) return;
    iconHolder.innerHTML = navIcon.innerHTML;
  };

  const showView = (name) => {
    $$(".view").forEach(v => v.classList.remove("active"));
    $("#view-" + name).classList.add("active");
    $$("#nav button").forEach(b => b.classList.toggle("active", b.dataset.view === name));
    const titleText = $("#viewTitle .title-text");
    if (titleText) titleText.textContent = viewMeta[name].title;
    $("#viewSub").textContent = viewMeta[name].sub;
    updateViewIcon(name);
    if (name === "dashboard") renderDashboardCharts();
  };

  $("#nav").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    showView(btn.dataset.view);
  });

  const MORE_DRAWER_KEY = "planos_more_open";
  const moreDrawer = $("#moreDrawer");
  const moreToggle = $("#moreToggle");
  const morePanel = $("#morePanel");
  const setMoreDrawerState = (open, { focusToggle = false } = {}) => {
    if (!moreDrawer || !moreToggle || !morePanel) return;
    moreDrawer.classList.toggle("is-open", open);
    moreToggle.setAttribute("aria-expanded", open ? "true" : "false");
    morePanel.setAttribute("aria-hidden", open ? "false" : "true");
    localStorage.setItem(MORE_DRAWER_KEY, open ? "1" : "0");
    if (!open && focusToggle) moreToggle.focus();
  };
  if (moreDrawer && moreToggle && morePanel) {
    const savedOpen = localStorage.getItem(MORE_DRAWER_KEY) === "1";
    setMoreDrawerState(savedOpen);
    moreToggle.addEventListener("click", () => {
      setMoreDrawerState(!moreDrawer.classList.contains("is-open"));
    });
    document.addEventListener("click", (e) => {
      if (!moreDrawer.classList.contains("is-open")) return;
      if (!moreDrawer.contains(e.target)) {
        setMoreDrawerState(false, { focusToggle: true });
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      if (moreDrawer.classList.contains("is-open")) {
        e.preventDefault();
        setMoreDrawerState(false, { focusToggle: true });
      }
    });
  }

  // Dialog helpers
  const modalRoot = $("#modalRoot");
  if (modalRoot) {
    $$("dialog").forEach((dlg) => {
      if (dlg.parentElement !== modalRoot) {
        modalRoot.appendChild(dlg);
      }
    });
  }

  let lockedScrollY = 0;
  const clearModalLock = () => {
    document.body.classList.remove("modal-open");
    document.documentElement.classList.remove("modal-open");
    if (document.body.dataset.scrollLocked) {
      delete document.body.dataset.scrollLocked;
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      window.scrollTo(0, lockedScrollY);
    }
  };
  const syncModalState = () => {
    const hasOpenDialog = !!document.querySelector("dialog[open]");
    if (hasOpenDialog) {
      document.body.classList.add("modal-open");
      document.documentElement.classList.add("modal-open");
      if (!document.body.dataset.scrollLocked) {
        lockedScrollY = window.scrollY || 0;
        document.body.dataset.scrollLocked = "true";
        document.body.style.position = "fixed";
        document.body.style.top = `-${lockedScrollY}px`;
        document.body.style.width = "100%";
      }
    } else {
      clearModalLock();
    }
  };
  const closeOpenDialogs = (exceptId) => {
    $$("dialog[open]").forEach((dlg) => {
      if (exceptId && dlg.id === exceptId) return;
      dlg.close();
    });
  };
  const openDlg = (id) => {
    const d = $("#"+id);
    if (d) {
      closeOpenDialogs(id);
      if (modalRoot && d.parentElement !== modalRoot) {
        modalRoot.appendChild(d);
      }
      if (!d.open) d.showModal();
      syncModalState();
      applyEnglishDigits(d);
    }
  };
  const closeDlg = (id) => {
    const d = $("#"+id);
    if (d && d.open) d.close();
    syncModalState();
  };
  $$("dialog").forEach((dlg) => {
    dlg.addEventListener("close", syncModalState);
    dlg.addEventListener("cancel", (e) => {
      e.preventDefault();
      dlg.close();
      syncModalState();
    });
    dlg.addEventListener("click", (e) => {
      if (e.target === dlg) {
        dlg.close();
        syncModalState();
      }
    });
  });
  document.addEventListener("click", (e) => {
    const c = e.target.closest("[data-close]");
    if(!c) return;
    closeDlg(c.dataset.close);
  });

  // =========================
  // Header Render
  // =========================
  const formatTimeParts = (date) => {
    const opts = { hour: "2-digit", minute: "2-digit", hour12: USE_12H_CLOCK };
    return date.toLocaleTimeString("en-GB", opts).replace(/\u200f/g, "");
  };
  const updateFlipClock = () => {
    const clock = $("#flipClock");
    if (!clock) return;
    const time = formatTimeParts(new Date());
    const match = time.match(/(\d+)\s*:\s*(\d+)/);
    if (!match) return;
    const digits = (match[1] + match[2]).padStart(4, "0").split("");
    const nodes = clock.querySelectorAll(".flip-digit");
    nodes.forEach((node, idx) => {
      const next = digits[idx] || "0";
      if (node.dataset.digit === next) return;
      node.dataset.digit = next;
      node.classList.remove("is-flipping");
      void node.offsetWidth;
      node.classList.add("is-flipping");
      const value = node.querySelector(".flip-value");
      if (value) value.textContent = next;
    });
  };

  const renderHeader = () => {
    $("#pname").textContent = state.profile.name || "نام شما";
    $("#ptitle").textContent = state.profile.title || "عنوان شما";
    const avatar = $("#avatar");
    avatar.innerHTML = "";
    if(state.profile.avatarData){
      const img = document.createElement("img");
      img.src = state.profile.avatarData;
      img.alt = state.profile.name || "Avatar";
      avatar.appendChild(img);
    } else {
      avatar.textContent = (state.profile.name || "پ").trim().slice(0,1).toUpperCase();
    }

    const tISO = todayISO();
    const j = isoToJalali(tISO);

    $("#todayWeekday").textContent = faDow[getFaWeekdayIndex(new Date())];
    $("#todayDay").textContent = toEnglishDigits(j.jd);
    $("#todayMonth").textContent = J_MONTHS[j.jm - 1];
    $("#todayYear").textContent = toEnglishDigits(j.jy);
    document.documentElement.setAttribute("dir", state.settings.rtl ? "rtl" : "ltr");
    document.documentElement.setAttribute("data-theme", state.settings.theme || "light");
    const activeView = document.querySelector("#nav button.active")?.dataset.view || "dashboard";
    const titleText = $("#viewTitle .title-text");
    if (titleText && viewMeta[activeView]) titleText.textContent = viewMeta[activeView].title;
    if (viewMeta[activeView]) $("#viewSub").textContent = viewMeta[activeView].sub;
    updateViewIcon(activeView);
  };

  const applyFocusMode = () => {
    const isFocus = !!state.settings.focusMode;
    document.body.classList.toggle("focus-mode", isFocus);
    const btn = $("#btnFocusMode");
    if(btn){
      btn.setAttribute("aria-pressed", isFocus ? "true" : "false");
      btn.classList.toggle("is-active", isFocus);
      const stateEl = $("#focusState");
      if (stateEl) stateEl.textContent = isFocus ? "روشن" : "خاموش";
    }
  };

  // =========================
  // Metrics
  // =========================
  const tasksByDate = (iso) => state.tasks.filter(t => t.date === iso);
  const projectsInRange = (s,e) => state.projects.filter(p => p.date >= s && p.date <= e);
  const calcTaskRate = (tasks) => {
    if(!tasks.length) return { total:0, done:0, rate:0 };
    const done = tasks.filter(x=>x.done).length;
    return { total:tasks.length, done, rate: Math.round(done/tasks.length*100) };
  };
  const calcIncome = (projects) => projects.reduce((sum,p)=>sum + Number(p.amount||0), 0);

  const currentJalaliYM = () => {
    const t = isoToJalali(todayISO());
    return { jy: t.jy, jm: t.jm };
  };

  // =========================
  // Dashboard
  // =========================
  let chartWeek = null, chartIncome = null, chartPortfolio = null;

  const renderDashboard = () => {
    const t = todayISO();
    const todayTasks = tasksByDate(t);
    const todayStats = calcTaskRate(todayTasks);

    const { jy, jm } = currentJalaliYM();
    const m = jalaliMonthRangeISO(jy, jm);

    const monthTasks = state.tasks.filter(x => x.date >= m.s && x.date <= m.e);
    const monthStats = calcTaskRate(monthTasks);

    const monthProjects = projectsInRange(m.s, m.e);
    const income = calcIncome(monthProjects);

    $("#dashTodayChip").textContent = todayStats.rate + "%";
    $("#dashTodayKpi").textContent = todayStats.done + " / " + todayStats.total;
    $("#dashTodayMeta").textContent = "انجام‌شده / کل تسک‌ها";
    $("#dashTodayBar").style.width = todayStats.rate + "%";

    $("#dashMonthChip").textContent = monthStats.rate + "%";
    $("#dashMonthKpi").textContent = monthStats.done + " / " + monthStats.total;
    $("#dashMonthMeta").textContent = "پیشرفت ماه (" + jalaliMonthLabel(jy, jm) + ")";
    $("#dashMonthBar").style.width = monthStats.rate + "%";

    $("#dashIncomeKpi").textContent = moneyFA(income) + " " + state.profile.currency;
    $("#dashIncomeMeta").textContent = monthProjects.length + " پروژه در این ماه";

    const saveTarget = Math.round(Number(state.profile.monthlyMinIncome||0) * Number(state.profile.savingsRateTarget||0));
    $("#dashSaveTarget").textContent = moneyFA(saveTarget) + " " + state.profile.currency;
    $("#dashSaveRate").textContent = Math.round((Number(state.profile.savingsRateTarget||0))*100) + "%";

    $("#dashMotivation").textContent = state.notes.motivation || "—";
    applyEnglishDigits();
  };

  const renderDashboardCharts = () => {
    const hasChart = typeof window.Chart !== "undefined";
    const setChartEmpty = (canvasId, emptyId, hasData) => {
      const canvas = $(canvasId);
      const empty = $(emptyId);
      if(canvas) canvas.style.display = hasData ? "block" : "none";
      if(empty) empty.style.display = hasData ? "none" : "flex";
    };

    if(!hasChart){
      setChartEmpty("#chartWeek", "#chartWeekEmpty", false);
      setChartEmpty("#chartIncome", "#chartIncomeEmpty", false);
      setChartEmpty("#chartPortfolio", "#chartPortfolioEmpty", false);
      return;
    }
    const rootStyles = getComputedStyle(document.documentElement);
    const isSmallScreen = window.matchMedia("(max-width: 560px)").matches;
    const chartFontSize = isSmallScreen ? 11 : 12;
    const chartLegendPadding = isSmallScreen ? 10 : 14;
    const chartTickPadding = isSmallScreen ? 6 : 10;
    const chartFont = rootStyles.getPropertyValue("--font-sans").trim() || "IRANSansX";
    const chartText = rootStyles.getPropertyValue("--text").trim() || "#ffffff";
    const chartMuted = rootStyles.getPropertyValue("--muted").trim() || "#94a3b8";
    const chartBorder = rootStyles.getPropertyValue("--border").trim() || "rgba(255,255,255,.12)";
    const chartPrimary = rootStyles.getPropertyValue("--primary").trim() || "#9ae6ff";
    const chartPrimarySoft = rootStyles.getPropertyValue("--primary-soft").trim() || "rgba(154,230,255,.18)";
    const chartSuccess = rootStyles.getPropertyValue("--success").trim() || "#7bffb5";
    const chartWarning = rootStyles.getPropertyValue("--warning").trim() || "#ffd97b";
    const chartDanger = rootStyles.getPropertyValue("--danger").trim() || "#ff7b7b";
    Chart.defaults.font.family = chartFont;
    Chart.defaults.font.size = chartFontSize;
    Chart.defaults.color = chartText;
    Chart.defaults.borderColor = chartBorder;
    [chartWeek, chartIncome, chartPortfolio].forEach(ch => { if(ch) ch.destroy(); });

    // Weekly completion
    const labels = [];
    const values = [];
    const weekCounts = [];
    const now = new Date();
    for(let i=6;i>=0;i--){
      const d = new Date(now);
      d.setDate(d.getDate()-i);
      const iso = d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
      const dayTasks = tasksByDate(iso);
      const s = calcTaskRate(dayTasks);
      labels.push(toEnglishDigits(isoToJalaliStr(iso).slice(5))); // MM/DD in jalali digits
      values.push(s.rate);
      weekCounts.push(dayTasks.length);
    }

    const hasWeekData = weekCounts.some(c => c > 0);
    setChartEmpty("#chartWeek", "#chartWeekEmpty", hasWeekData);
    if(hasWeekData){
      chartWeek = new Chart($("#chartWeek"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "درصد انجام تسک",
            data: values,
            tension: .35,
            fill: true,
            borderColor: chartPrimary,
            backgroundColor: chartPrimarySoft,
            pointBackgroundColor: chartPrimary,
            pointRadius: isSmallScreen ? 2.5 : 3
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{
              ticks:{
                callback:(v, i)=> toEnglishDigits(labels[i] ?? v),
                color: chartMuted,
                font:{ family: chartFont, size: chartFontSize },
                maxRotation: isSmallScreen ? 0 : 25,
                minRotation: isSmallScreen ? 0 : 0,
                padding: chartTickPadding
              },
              grid:{ color: chartBorder }
            },
            y:{
              min:0,
              max:100,
              ticks:{
                callback:(v)=> toEnglishDigits(v+"%"),
                color: chartMuted,
                font:{ family: chartFont, size: chartFontSize },
                padding: chartTickPadding
              },
              grid:{ color: chartBorder }
            }
          },
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                title:(items)=> toEnglishDigits(items[0]?.label ?? ""),
                label:(ctx)=> toEnglishDigits(`${ctx.dataset.label}: ${ctx.parsed.y}%`)
              }
            }
          }
        }
      });
    }

    // Income last 6 Jalali months
    const { jy, jm } = currentJalaliYM();
    const incLabels = [];
    const incValues = [];
    const incCounts = [];
    for(let i=5;i>=0;i--){
      const m = shiftJalaliMonth(jy, jm, -i);
      const r = jalaliMonthRangeISO(m.jy, m.jm);
      const monthProjects = projectsInRange(r.s, r.e);
      const inc = calcIncome(monthProjects);
      incLabels.push(toEnglishDigits(jalaliMonthLabel(m.jy, m.jm)));
      incValues.push(inc);
      incCounts.push(monthProjects.length);
    }

    const hasIncomeData = incCounts.some(c => c > 0);
    setChartEmpty("#chartIncome", "#chartIncomeEmpty", hasIncomeData);
    if(hasIncomeData){
      chartIncome = new Chart($("#chartIncome"), {
        type: "bar",
        data: {
          labels: incLabels,
          datasets: [{
            label: "درآمد",
            data: incValues,
            backgroundColor: chartPrimary,
            borderRadius: 10
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{
              ticks:{
                callback:(v, i)=> toEnglishDigits(incLabels[i] ?? v),
                color: chartMuted,
                font:{ family: chartFont, size: chartFontSize },
                maxRotation: isSmallScreen ? 0 : 25,
                minRotation: isSmallScreen ? 0 : 0,
                padding: chartTickPadding
              },
              grid:{ color: chartBorder }
            },
            y:{
              ticks:{
                callback:(v)=> toEnglishDigits(moneyFA(v)),
                color: chartMuted,
                font:{ family: chartFont, size: chartFontSize },
                padding: chartTickPadding
              },
              grid:{ color: chartBorder }
            }
          },
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                title:(items)=> toEnglishDigits(items[0]?.label ?? ""),
                label:(ctx)=> toEnglishDigits(`${ctx.dataset.label}: ${moneyFA(ctx.parsed.y)}`)
              }
            }
          }
        }
      });
    }

    // Portfolio (grouped by type+unit)
    const groups = new Map();
    for(const h of state.assets.holdings){
      const key = `${h.type} (${h.unit})`;
      groups.set(key, (groups.get(key)||0) + Number(h.amount||0));
    }
    const portfolioPalette = [chartPrimary, chartSuccess, chartWarning, chartDanger, chartPrimarySoft];
    const portfolioLabels = Array.from(groups.keys()).map(label => toEnglishDigits(label));
    const portfolioValues = Array.from(groups.values());
    const hasPortfolioData = state.assets.holdings.some(h => Number(h.amount || 0) > 0);
    setChartEmpty("#chartPortfolio", "#chartPortfolioEmpty", hasPortfolioData);
    if(hasPortfolioData){
      chartPortfolio = new Chart($("#chartPortfolio"), {
        type: "doughnut",
        data: {
          labels: portfolioLabels,
          datasets: [{
            data: portfolioValues,
            backgroundColor: portfolioLabels.map((_, i) => portfolioPalette[i % portfolioPalette.length]),
            borderColor: chartBorder
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{
              position:"bottom",
              labels:{
                font:{ family: chartFont, size: chartFontSize },
                color: chartText,
                padding: chartLegendPadding,
                boxWidth: isSmallScreen ? 10 : 12
              }
            },
            tooltip:{
              callbacks:{
                label:(ctx)=> toEnglishDigits(`${ctx.label}: ${moneyFA(ctx.parsed)}`)
              }
            }
          }
        }
      });
    }
    applyEnglishDigits();
  };

  // =========================
  // Planner (Tasks)
  // =========================
  let plannerDate = todayISO();
  let showDone = true;
  let editingTaskId = null;

  const priorityLabel = (p) => (p==="high" ? "اولویت زیاد" : (p==="low" ? "اولویت کم" : "اولویت متوسط"));

  const renderPlanner = () => {
    $("#plannerDate").value = plannerDate;
    $("#plannerJalaliBadge").textContent = isoToJalaliStr(plannerDate);

    const tasks = tasksByDate(plannerDate).slice().sort((a,b) => (a.done===b.done ? 0 : (a.done?1:-1)));
    const filtered = showDone ? tasks : tasks.filter(t => !t.done);
    const stats = calcTaskRate(tasks);

    $("#plannerCount").textContent = stats.total;
    $("#plannerDone").textContent = stats.done;
    $("#plannerRate").textContent = stats.rate + "%";
    $("#plannerBar").style.width = stats.rate + "%";
    $("#showDoneState").textContent = showDone ? "روشن" : "خاموش";

    const list = $("#plannerList");
    list.innerHTML = "";
    $("#plannerEmpty").style.display = tasks.length ? "none" : "block";

    filtered.forEach(t => {
      const priChip = t.priority === "high" ? "chip danger" : (t.priority === "low" ? "chip" : "chip acc");
      const doneChip = t.done ? "mini ok" : "mini";
      const item = document.createElement("div");
      item.className = `item${t.done ? " done" : ""}`;
      item.innerHTML = `
        <div class="item-main">
          <div class="item-title">${escapeHtml(t.title)}</div>
          <div class="item-meta">
            <span class="mini">${escapeHtml(t.category || "—")}</span>
            <span class="mini acc">${escapeHtml(t.timeBlock || "—")}</span>
            <span class="${priChip}">${priorityLabel(t.priority)}</span>
            <span class="${doneChip}">${t.done ? "انجام شد" : "در انتظار"}</span>
            <span class="mini">⏱ ${Number(t.estimateMin||0)} دقیقه</span>
          </div>
        </div>
        <div class="item-actions">
          <button class="btn btn-icon" title="تیک" data-act="toggle" data-id="${t.id}">✓</button>
          <button class="btn btn-icon" title="ویرایش" data-act="edit" data-id="${t.id}">✎</button>
          <button class="btn btn-icon btn-danger" title="حذف" data-act="del" data-id="${t.id}">🗑</button>
        </div>
      `;
      list.appendChild(item);
    });
    applyEnglishDigits();
  };

  const openTaskDialog = (task=null) => {
    editingTaskId = task ? task.id : null;
    $("#dlgTaskTitle").textContent = task ? "ویرایش تسک" : "افزودن تسک";
    $("#btnTaskDelete").style.visibility = task ? "visible" : "hidden";

    $("#taskTitle").value = task ? task.title : "";
    $("#taskDate").value = task ? task.date : plannerDate;
    $("#taskDateJ").textContent = isoToJalaliStr($("#taskDate").value || plannerDate);

    $("#taskPriority").value = task ? task.priority : "medium";
    $("#taskCategory").value = task ? task.category : "کار";
    $("#taskTimeBlock").value = task ? task.timeBlock : "صبح";
    $("#taskEstimate").value = task ? Number(task.estimateMin||0) : 30;
    $("#taskDone").checked = task ? !!task.done : false;

    openDlg("dlgTask");
  };

  $("#taskDate").addEventListener("change", (e) => {
    const iso = e.target.value || plannerDate;
    $("#taskDateJ").textContent = isoToJalaliStr(iso);
  });

  $("#plannerDate").addEventListener("change", (e) => {
    plannerDate = e.target.value || todayISO();
    renderPlanner();
  });

  $("#btnAddTask").addEventListener("click", () => { showView("planner"); openTaskDialog(null); });
  $("#btnAddTask2").addEventListener("click", () => openTaskDialog(null));
  $("#btnPlannerEmptyAdd").addEventListener("click", () => openTaskDialog(null));
  $("#chartWeekCTA").addEventListener("click", () => { showView("planner"); openTaskDialog(null); });
  $("#chartIncomeCTA").addEventListener("click", () => { showView("projects"); openProjectDialog(null); });
  $("#chartPortfolioCTA").addEventListener("click", () => { showView("finance"); openHoldingDialog(null); });

  $("#btnQuickAdd").addEventListener("click", () => {
    const title = $("#quickTaskTitle").value.trim();
    if(!title){ toast("عنوان تسک رو بنویس."); return; }
    state.tasks.unshift({ id: uid(), title, date: plannerDate, done:false, priority:"medium", category:"کار", timeBlock:"صبح", estimateMin:30 });
    $("#quickTaskTitle").value = "";
    saveState(); renderPlanner(); renderDashboard(); renderDashboardCharts();
    toast("تسک اضافه شد ✅");
  });

  $("#toggleShowDone").addEventListener("click", () => { showDone = !showDone; renderPlanner(); });

  $("#plannerList").addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const task = state.tasks.find(t => t.id === id);
    if(!task) return;

    if(act==="toggle"){
      const item = btn.closest(".item");
      const nextDone = !task.done;
      if(item && !prefersReducedMotion.matches && nextDone){
        item.classList.add("task-complete");
        item.addEventListener("animationend", () => item.classList.remove("task-complete"), { once: true });
      }
      task.done = nextDone;
      saveState();
      const update = () => { renderPlanner(); renderDashboard(); renderDashboardCharts(); };
      if(prefersReducedMotion.matches){ update(); }
      else { setTimeout(update, 160); }
      return;
    }
    if(act==="edit"){ openTaskDialog(task); return; }
    if(act==="del"){
      state.tasks = state.tasks.filter(t => t.id !== id);
      saveState(); renderPlanner(); renderDashboard(); renderDashboardCharts();
      toast("حذف شد.");
      return;
    }
  });

  $("#btnTaskSave").addEventListener("click", () => {
    const title = $("#taskTitle").value.trim();
    const date = $("#taskDate").value || plannerDate;
    if(!title){ toast("عنوان ضروریه."); return; }

    const patch = {
      title,
      date,
      priority: $("#taskPriority").value,
      category: $("#taskCategory").value.trim() || "کار",
      timeBlock: $("#taskTimeBlock").value,
      estimateMin: Number($("#taskEstimate").value || 0),
      done: $("#taskDone").checked
    };

    if(editingTaskId){
      const idx = state.tasks.findIndex(t => t.id === editingTaskId);
      if(idx >= 0) state.tasks[idx] = { ...state.tasks[idx], ...patch };
      toast("تسک آپدیت شد ✅");
    } else {
      state.tasks.unshift({ id: uid(), ...patch });
      toast("تسک ذخیره شد ✅");
    }

    plannerDate = date;
    saveState();
    closeDlg("dlgTask");
    renderAll();
    renderDashboardCharts();
  });

  $("#btnTaskDelete").addEventListener("click", () => {
    if(!editingTaskId) return;
    state.tasks = state.tasks.filter(t => t.id !== editingTaskId);
    saveState();
    closeDlg("dlgTask");
    renderAll();
    renderDashboardCharts();
    toast("تسک حذف شد.");
  });

  // =========================
  // Calendar (Jalali cursor)
  // =========================
  let monthCursor = currentJalaliYM(); // {jy,jm}

  const renderCalendar = () => {
    $("#calMonthLabel").textContent = jalaliMonthLabel(monthCursor.jy, monthCursor.jm);

    // DOW header
    const dow = $("#calDow");
    dow.innerHTML = "";
    faDow.forEach(name => { const d = document.createElement("div"); d.className = "cal-dow"; d.textContent = name; dow.appendChild(d); });

    // first day of jalali month -> gregorian date
    const gFirst = toGregorian(monthCursor.jy, monthCursor.jm, 1);
    const firstDate = new Date(gFirst.gy, gFirst.gm - 1, gFirst.gd);
    const lead = getFaWeekdayIndex(firstDate);

    const totalDays = jalaaliMonthLength(monthCursor.jy, monthCursor.jm);

    const grid = $("#calGrid");
    grid.innerHTML = "";

    for(let i=0;i<lead;i++){
      const cell = document.createElement("div");
      cell.className = "cal-day blank";
      cell.innerHTML = `<div class="cal-top"><span class="cal-num">—</span></div>`;
      grid.appendChild(cell);
    }

    for(let jd=1; jd<=totalDays; jd++){
      const iso = jalaliToISO(monthCursor.jy, monthCursor.jm, jd);

      const dayTasks = tasksByDate(iso);
      const done = dayTasks.filter(t=>t.done).length;
      const dayProjects = state.projects.filter(p=>p.date === iso);
      const inc = calcIncome(dayProjects);

      const cell = document.createElement("div");
      cell.className = "cal-day";
      cell.dataset.iso = iso;
      cell.innerHTML = `
        <div class="cal-top">
          <span class="cal-num">${toEnglishDigits(jd)}</span>
          <span class="mini">${isoToJalaliStr(iso)}</span>
        </div>
        <div class="cal-badges">
          <span class="mini acc">تسک: ${toEnglishDigits(dayTasks.length)}</span>
          <span class="mini ok">انجام: ${toEnglishDigits(done)}</span>
          <span class="mini">پروژه: ${toEnglishDigits(dayProjects.length)}</span>
          ${inc ? `<span class="mini acc">درآمد: ${moneyFA(inc)}</span>` : ""}
        </div>
      `;
      grid.appendChild(cell);
    }
    applyEnglishDigits();
  };

  $("#btnPrevMonth").addEventListener("click", () => {
    monthCursor = shiftJalaliMonth(monthCursor.jy, monthCursor.jm, -1);
    renderCalendar();
  });
  $("#btnNextMonth").addEventListener("click", () => {
    monthCursor = shiftJalaliMonth(monthCursor.jy, monthCursor.jm, +1);
    renderCalendar();
  });

  $("#calGrid").addEventListener("click", (e) => {
    const cell = e.target.closest(".cal-day");
    if(!cell || cell.classList.contains("blank")) return;
    const iso = cell.dataset.iso;
    if(!iso) return;
    plannerDate = iso;
    showView("planner");
    renderPlanner();
  });

  // =========================
  // Projects
  // =========================
  let editingProjectId = null;
  const statusLabel = (s) => (s==="done" ? "انجام‌شده" : (s==="doing" ? "در حال انجام" : "در انتظار"));

  const openProjectDialog = (proj=null) => {
    editingProjectId = proj ? proj.id : null;
    $("#dlgProjectTitle").textContent = proj ? "ویرایش پروژه" : "افزودن پروژه";
    $("#btnProjectDelete").style.visibility = proj ? "visible" : "hidden";

    $("#projName").value = proj ? proj.name : "";
    $("#projClient").value = proj ? proj.client : "";
    $("#projAmount").value = proj ? Number(proj.amount||0) : "";
    $("#projDate").value = proj ? proj.date : todayISO();
    $("#projDateJ").textContent = isoToJalaliStr($("#projDate").value || todayISO());
    $("#projStatus").value = proj ? proj.status : "todo";
    $("#projTags").value = proj ? (proj.tags||[]).join(", ") : "";
    $("#projNotes").value = proj ? (proj.notes||"") : "";

    openDlg("dlgProject");
  };

  $("#projDate").addEventListener("change", (e) => {
    const iso = e.target.value || todayISO();
    $("#projDateJ").textContent = isoToJalaliStr(iso);
  });

  const renderProjects = () => {
    const filter = $("#projectFilter").value || "all";
    const tbody = $("#projectTbody");
    tbody.innerHTML = "";

    const { jy, jm } = currentJalaliYM();
    const nowRange = jalaliMonthRangeISO(jy, jm);
    const monthProjects = projectsInRange(nowRange.s, nowRange.e);
    $("#projMonthCount").textContent = toEnglishDigits(monthProjects.length);
    $("#projMonthIncome").textContent = moneyFA(calcIncome(monthProjects)) + " " + state.profile.currency;

    const list = (filter==="all") ? state.projects : state.projects.filter(p => p.status === filter);
    $("#projectsEmpty").style.display = list.length ? "none" : "block";

    list.forEach(p => {
      const tr = document.createElement("tr");
      const chipClass = p.status==="done" ? "chip ok" : (p.status==="doing" ? "chip acc" : "chip");
      tr.innerHTML = `
        <td><b>${escapeHtml(p.name)}</b><div class="muted2 small">${(p.tags||[]).map(t=>"#"+escapeHtml(t)).join(" ")}</div></td>
        <td>${escapeHtml(p.client||"—")}</td>
        <td class="nowrap">${moneyFA(p.amount)} ${state.profile.currency}</td>
        <td class="nowrap"><b>${isoToJalaliStr(p.date)}</b><div class="muted2 small">${escapeHtml(p.date)}</div></td>
        <td><span class="${chipClass}">${statusLabel(p.status)}</span></td>
        <td class="nowrap">
          <button class="btn btn-icon" data-act="edit" data-id="${p.id}" title="ویرایش">✎</button>
          <button class="btn btn-icon btn-danger" data-act="del" data-id="${p.id}" title="حذف">🗑</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    applyEnglishDigits();
  };

  $("#projectFilter").addEventListener("change", renderProjects);
  $("#btnAddProject").addEventListener("click", () => { showView("projects"); openProjectDialog(null); });
  $("#btnAddProject2").addEventListener("click", () => openProjectDialog(null));

  $("#projectTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const proj = state.projects.find(p => p.id === id);
    if(!proj) return;

    if(act==="edit"){ openProjectDialog(proj); return; }
    if(act==="del"){
      state.projects = state.projects.filter(p => p.id !== id);
      saveState(); renderProjects(); renderDashboard(); renderDashboardCharts();
      toast("پروژه حذف شد.");
    }
  });

  $("#btnProjectSave").addEventListener("click", () => {
    const name = $("#projName").value.trim();
    if(!name){ toast("عنوان پروژه ضروریه."); return; }

    const tags = $("#projTags").value.split(",").map(x=>x.trim()).filter(Boolean);
    const patch = {
      name,
      client: $("#projClient").value.trim(),
      amount: Number($("#projAmount").value || 0),
      date: $("#projDate").value || todayISO(),
      status: $("#projStatus").value,
      tags,
      notes: $("#projNotes").value
    };

    if(editingProjectId){
      const idx = state.projects.findIndex(p => p.id === editingProjectId);
      if(idx >= 0) state.projects[idx] = { ...state.projects[idx], ...patch };
      toast("پروژه آپدیت شد ✅");
    } else {
      state.projects.unshift({ id: uid(), ...patch });
      toast("پروژه ذخیره شد ✅");
    }

    saveState();
    closeDlg("dlgProject");
    renderAll();
    renderDashboardCharts();
  });

  $("#btnProjectDelete").addEventListener("click", () => {
    if(!editingProjectId) return;
    state.projects = state.projects.filter(p => p.id !== editingProjectId);
    saveState();
    closeDlg("dlgProject");
    renderAll();
    renderDashboardCharts();
    toast("پروژه حذف شد.");
  });

  // =========================
  // Goals
  // =========================
  let editingGoalId = null;

  const goalRate = (g) => {
    const t = Number(g.target||0);
    const c = Number(g.current||0);
    if(!t) return 0;
    return Math.max(0, Math.min(100, Math.round((c/t)*100)));
  };

  const openGoalDialog = (goal=null) => {
    editingGoalId = goal ? goal.id : null;
    $("#dlgGoalTitle").textContent = goal ? "ویرایش هدف" : "افزودن هدف";
    $("#btnGoalDelete").style.visibility = goal ? "visible" : "hidden";

    $("#goalTitle").value = goal ? goal.title : "";
    $("#goalHorizon").value = goal ? goal.horizon : "3 ماه";
    $("#goalMetric").value = goal ? goal.metric : "عادت";
    $("#goalTarget").value = goal ? Number(goal.target||0) : 100;
    $("#goalCurrent").value = goal ? Number(goal.current||0) : 0;
    $("#goalNotes").value = goal ? (goal.notes||"") : "";
    $("#goalMilestones").value = goal ? (goal.milestones||[]).map(m=>m.text).join("\n") : "";
    openDlg("dlgGoal");
  };

  const renderGoals = () => {
    const list = $("#goalsList");
    list.innerHTML = "";
    $("#goalsEmpty").style.display = state.goals.length ? "none" : "block";

    state.goals.forEach(g => {
      const rate = goalRate(g);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <div>
            <h3 style="margin-bottom:2px">${escapeHtml(g.title)}</h3>
            <div class="muted small">افق: ${escapeHtml(g.horizon||"—")} • متریک: ${escapeHtml(g.metric||"—")}</div>
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary" data-act="editGoal" data-id="${g.id}">ویرایش</button>
            <button class="btn btn-danger" data-act="delGoal" data-id="${g.id}">حذف</button>
          </div>
        </div>

        <div style="margin-top:10px" class="chips">
          <span class="chip acc">فعلی: <b>${moneyFA(g.current)}</b></span>
          <span class="chip">هدف: <b>${moneyFA(g.target)}</b></span>
          <span class="chip ok">پیشرفت: <b>${rate}%</b></span>
        </div>

        <div style="margin-top:10px" class="bar"><i style="width:${rate}%"></i></div>

        <div class="sep"></div>
        <div class="row" style="gap:10px;align-items:stretch">
          <div style="flex:1">
            <label>آپدیت مقدار فعلی</label>
            <input class="input" type="number" value="${Number(g.current||0)}" data-act="curInput" data-id="${g.id}" />
          </div>
          <div style="width: 180px">
            <label>&nbsp;</label>
            <button class="btn btn-secondary" data-act="saveCur" data-id="${g.id}">ذخیره مقدار</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="row">
          <h3 style="margin:0">مایلستون‌ها</h3>
          <span class="muted2 small">${(g.milestones||[]).filter(m=>m.done).length}/${(g.milestones||[]).length}</span>
        </div>

        <div class="list" style="margin-top:10px">
          ${(g.milestones||[]).map(m => `
            <div class="item" style="align-items:center">
              <div class="item-main">
                <div class="item-title" style="${m.done ? "text-decoration:line-through;opacity:.75" : ""}">${escapeHtml(m.text)}</div>
              </div>
              <div class="item-actions">
                <button class="btn btn-icon" data-act="toggleMs" data-gid="${g.id}" data-mid="${m.id}">${m.done ? "↺" : "✓"}</button>
              </div>
            </div>
          `).join("")}
        </div>

        ${g.notes ? `<div class="sep"></div><div class="muted small" style="line-height:1.9">${escapeHtml(g.notes)}</div>` : ""}
      `;
      list.appendChild(card);
    });
    applyEnglishDigits();
  };

  $("#btnAddGoal").addEventListener("click", () => { showView("goals"); openGoalDialog(null); });
  $("#btnAddGoal2").addEventListener("click", () => openGoalDialog(null));

  $("#goalsList").addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const act = btn.dataset.act;

    if(act==="editGoal"){
      const goal = state.goals.find(g => g.id === btn.dataset.id);
      if(goal) openGoalDialog(goal);
      return;
    }
    if(act==="delGoal"){
      const id = btn.dataset.id;
      state.goals = state.goals.filter(g => g.id !== id);
      saveState(); renderGoals(); toast("هدف حذف شد.");
      return;
    }
    if(act==="toggleMs"){
      const gid = btn.dataset.gid;
      const mid = btn.dataset.mid;
      const goal = state.goals.find(g => g.id === gid);
      if(!goal) return;
      const ms = (goal.milestones||[]).find(m => m.id === mid);
      if(!ms) return;
      ms.done = !ms.done;
      saveState(); renderGoals(); toast("آپدیت شد.");
      return;
    }
    if(act==="saveCur"){
      const id = btn.dataset.id;
      const goal = state.goals.find(g => g.id === id);
      if(!goal) return;
      const input = $(`[data-act="curInput"][data-id="${id}"]`, $("#goalsList"));
      goal.current = Number(input.value || 0);
      saveState(); renderGoals(); toast("مقدار ذخیره شد ✅");
      return;
    }
  });

  $("#btnGoalSave").addEventListener("click", () => {
    const title = $("#goalTitle").value.trim();
    if(!title){ toast("عنوان هدف ضروریه."); return; }

    const milestones = $("#goalMilestones").value
      .split("\n").map(x=>x.trim()).filter(Boolean)
      .map(text => ({ id: uid(), text, done:false }));

    const patch = {
      title,
      horizon: $("#goalHorizon").value.trim() || "—",
      metric: $("#goalMetric").value.trim() || "—",
      target: Number($("#goalTarget").value || 0),
      current: Number($("#goalCurrent").value || 0),
      notes: $("#goalNotes").value,
      milestones
    };

    if(editingGoalId){
      const idx = state.goals.findIndex(g => g.id === editingGoalId);
      if(idx >= 0){
        const prev = state.goals[idx];
        const prevMap = new Map((prev.milestones||[]).map(m => [m.text, m.done]));
        patch.milestones = patch.milestones.map(m => ({...m, done: !!prevMap.get(m.text)}));
        state.goals[idx] = { ...prev, ...patch };
      }
      toast("هدف آپدیت شد ✅");
    } else {
      state.goals.unshift({ id: uid(), ...patch });
      toast("هدف ذخیره شد ✅");
    }

    saveState();
    closeDlg("dlgGoal");
    renderAll();
  });

  $("#btnGoalDelete").addEventListener("click", () => {
    if(!editingGoalId) return;
    state.goals = state.goals.filter(g => g.id !== editingGoalId);
    saveState();
    closeDlg("dlgGoal");
    renderAll();
    toast("هدف حذف شد.");
  });

  // =========================
  // Finance / Holdings
  // =========================
  let editingHoldingId = null;

  const openHoldingDialog = (h=null) => {
    editingHoldingId = h ? h.id : null;
    $("#dlgHoldingTitle").textContent = h ? "ویرایش دارایی" : "افزودن دارایی";
    $("#btnHoldingDelete").style.visibility = h ? "visible" : "hidden";

    $("#holdType").value = h ? h.type : "طلا";
    $("#holdUnit").value = h ? h.unit : "تومان";
    $("#holdAmount").value = h ? Number(h.amount||0) : "";

    openDlg("dlgHolding");
  };

  const renderHoldings = () => {
    const tbody = $("#holdingsTbody");
    tbody.innerHTML = "";
    $("#holdingsEmpty").style.display = state.assets.holdings.length ? "none" : "block";

    state.assets.holdings.forEach(h => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(h.type)}</b></td>
        <td>${moneyFA(h.amount)}</td>
        <td>${escapeHtml(h.unit)}</td>
        <td class="nowrap">
          <button class="btn btn-icon" data-act="editHold" data-id="${h.id}">✎</button>
          <button class="btn btn-icon btn-danger" data-act="delHold" data-id="${h.id}">🗑</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    applyEnglishDigits();
  };

  const renderFinancePlan = () => {
    $("#monthlyMinIncome").value = Number(state.profile.monthlyMinIncome||0);
    $("#savingsRateTarget").value = Number(state.profile.savingsRateTarget||0);

    const split = state.assets.plan.split;
    $("#splitGold").value = Number(split.gold||0);
    $("#splitCrypto").value = Number(split.crypto||0);
    $("#splitSilver").value = Number(split.silver||0);
    $("#splitCash").value = Number(split.cash||0);

    const sum = Number(split.gold||0) + Number(split.crypto||0) + Number(split.silver||0) + Number(split.cash||0);
    $("#splitSum").textContent = sum + "%";
    $("#splitWarn").style.display = (sum === 100) ? "none" : "inline-flex";

    const base = Number(state.profile.monthlyMinIncome||0) * Number(state.profile.savingsRateTarget||0);
    const suggestions = [
      { label: "طلا", pct: split.gold, val: base * (split.gold/100) },
      { label: "کریپتو", pct: split.crypto, val: base * (split.crypto/100) },
      { label: "نقره", pct: split.silver, val: base * (split.silver/100) },
      { label: "نقد/تتر آزاد", pct: split.cash, val: base * (split.cash/100) }
    ];

    const box = $("#financeSuggestions");
    box.innerHTML = "";
    suggestions.forEach(s => {
      const el = document.createElement("span");
      el.className = "chip";
      el.innerHTML = `${s.label}: <b>${moneyFA(Math.round(s.val))}</b> ${state.profile.currency} <span class="muted2">(${s.pct}%)</span>`;
      box.appendChild(el);
    });
    applyEnglishDigits();
  };

  const renderFinance = () => { renderHoldings(); renderFinancePlan(); };

  $("#btnAddHolding").addEventListener("click", () => { showView("finance"); openHoldingDialog(null); });
  $("#btnAddHolding2").addEventListener("click", () => openHoldingDialog(null));

  $("#holdingsTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]");
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const h = state.assets.holdings.find(x => x.id === id);
    if(!h) return;

    if(act==="editHold"){ openHoldingDialog(h); return; }
    if(act==="delHold"){
      state.assets.holdings = state.assets.holdings.filter(x => x.id !== id);
      saveState(); renderFinance(); renderDashboard(); renderDashboardCharts();
      toast("دارایی حذف شد.");
    }
  });

  $("#btnHoldingSave").addEventListener("click", () => {
    const type = $("#holdType").value.trim();
    const unit = $("#holdUnit").value.trim();
    const amount = Number($("#holdAmount").value || 0);
    if(!type || !unit){ toast("نوع و واحد ضروریه."); return; }

    const patch = { type, unit, amount };

    if(editingHoldingId){
      const idx = state.assets.holdings.findIndex(x => x.id === editingHoldingId);
      if(idx >= 0) state.assets.holdings[idx] = { ...state.assets.holdings[idx], ...patch };
      toast("دارایی آپدیت شد ✅");
    } else {
      state.assets.holdings.unshift({ id: uid(), ...patch });
      toast("دارایی ذخیره شد ✅");
    }

    saveState();
    closeDlg("dlgHolding");
    renderFinance();
    renderDashboard();
    renderDashboardCharts();
  });

  $("#btnHoldingDelete").addEventListener("click", () => {
    if(!editingHoldingId) return;
    state.assets.holdings = state.assets.holdings.filter(x => x.id !== editingHoldingId);
    saveState();
    closeDlg("dlgHolding");
    renderFinance();
    renderDashboard();
    renderDashboardCharts();
    toast("دارایی حذف شد.");
  });

  $("#monthlyMinIncome").addEventListener("input", (e) => { state.profile.monthlyMinIncome = Number(e.target.value || 0); saveState(); renderFinancePlan(); renderDashboard(); });
  $("#savingsRateTarget").addEventListener("input", (e) => { state.profile.savingsRateTarget = Number(e.target.value || 0); saveState(); renderFinancePlan(); renderDashboard(); });

  const bindSplit = (id, key) => {
    $(id).addEventListener("input", (e) => {
      state.assets.plan.split[key] = Number(e.target.value || 0);
      saveState(); renderFinancePlan(); renderDashboard();
    });
  };
  bindSplit("#splitGold","gold");
  bindSplit("#splitCrypto","crypto");
  bindSplit("#splitSilver","silver");
  bindSplit("#splitCash","cash");

  $("#btnNormalizeSplit").addEventListener("click", () => {
    const s = state.assets.plan.split;
    const sum = Number(s.gold||0)+Number(s.crypto||0)+Number(s.silver||0)+Number(s.cash||0);
    if(sum <= 0){ toast("اول درصدها رو وارد کن."); return; }
    s.gold = Math.round((s.gold/sum)*100);
    s.crypto = Math.round((s.crypto/sum)*100);
    s.silver = Math.round((s.silver/sum)*100);
    s.cash = 100 - (s.gold + s.crypto + s.silver);
    saveState(); renderFinancePlan(); toast("نرمال شد ✅");
  });

  // =========================
  // Notes
  // =========================
  const updateNotesEmpty = () => {
    const emptyNotes = !state.notes.daily && !state.notes.motivation && !state.notes.journal && !state.notes.ideas;
    $("#notesEmpty").style.display = emptyNotes ? "block" : "none";
  };

  const renderNotes = () => {
    $("#noteDaily").value = state.notes.daily || "";
    $("#noteMotivation").value = state.notes.motivation || "";
    $("#noteJournal").value = state.notes.journal || "";
    $("#noteIdeas").value = state.notes.ideas || "";
    updateNotesEmpty();
    applyEnglishDigits();
  };

  const bindNote = (id, key) => {
    $(id).addEventListener("input", (e) => {
      state.notes[key] = e.target.value;
      saveState();
      updateNotesEmpty();
      if(key === "motivation") $("#dashMotivation").textContent = state.notes.motivation || "—";
    });
  };
  bindNote("#noteDaily","daily");
  bindNote("#noteMotivation","motivation");
  bindNote("#noteJournal","journal");
  bindNote("#noteIdeas","ideas");

  $("#btnStartNotes").addEventListener("click", () => {
    showView("notes");
    $("#noteDaily").focus();
  });

  $("#btnGoNotes").addEventListener("click", () => showView("notes"));

  $("#btnFocusMode").addEventListener("click", () => {
    state.settings.focusMode = !state.settings.focusMode;
    saveState();
    applyFocusMode();
  });

  // =========================
  // Profile
  // =========================
  let pendingAvatarData = state.profile.avatarData || "";
  const openProfileDialog = () => {
    $("#profileName").value = state.profile.name || "";
    $("#profileTitle").value = state.profile.title || "";
    $("#profileAvatar").value = "";
    $("#profilePin").value = "";
    pendingAvatarData = state.profile.avatarData || "";
    openDlg("dlgProfile");
  };

  $("#profileButton").addEventListener("click", openProfileDialog);
  $("#profileButton").addEventListener("keydown", (e) => {
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      openProfileDialog();
    }
  });

  $("#profileAvatar").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file){ return; }
    const reader = new FileReader();
    reader.onload = () => {
      pendingAvatarData = reader.result || "";
    };
    reader.readAsDataURL(file);
  });

  $("#btnRemoveAvatar").addEventListener("click", (e) => {
    e.preventDefault();
    pendingAvatarData = "";
    $("#profileAvatar").value = "";
    toast("آواتار حذف شد.");
  });

  $("#btnProfileSave").addEventListener("click", async () => {
    const nameValue = $("#profileName").value.trim();
    const titleValue = $("#profileTitle").value.trim();
    const pinValue = normalizePin($("#profilePin").value.trim());
    if (pinValue && pinValue.length !== 4) {
      toast("پین باید 4 رقم باشد.");
      return;
    }

    state.profile.name = nameValue;
    state.profile.title = titleValue;
    state.profile.avatarData = pendingAvatarData || "";
    if (pinValue) {
      if (!hasWebCrypto()) {
        toast("مرورگر از ذخیره امن پین پشتیبانی نمی‌کند.");
        return;
      }
      try {
        const salt = generateSalt();
        state.settings.pinSalt = salt;
        state.settings.pinHash = await hashPin(pinValue, salt);
      } catch {
        toast("خطا در ذخیره امن پین.");
        return;
      }
    } else {
      state.settings.pinSalt = "";
      state.settings.pinHash = "";
    }
    if ("pin" in state.settings) delete state.settings.pin;
    if (!pinValue) {
      sessionStorage.removeItem(LOCK_SESSION_KEY);
      hideLock();
    }
    saveState();
    closeDlg("dlgProfile");
    renderHeader();
    updateLockAvailability();
    toast("پروفایل ذخیره شد ✅");
  });

  // =========================
  // Theme / Export / Import / Reset
  // =========================
  $("#btnTheme").addEventListener("click", () => {
    const next = (state.settings.theme === "dark") ? "light" : "dark";
    state.settings.theme = next;
    saveState();
    renderHeader();
    renderDashboardCharts();
    toast("تم تغییر کرد");
  });

  $("#btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "PlanOS-backup.json";
    a.click();
    URL.revokeObjectURL(url);
    toast("خروجی گرفته شد ✅");
  });

  $("#btnImport").addEventListener("click", () => {
    $("#importFile").value = "";
    openDlg("dlgImport");
  });

  $("#btnRestoreDaily").addEventListener("click", async () => {
    if (!("indexedDB" in window)) {
      toast("مرورگر از بکاپ روزانه پشتیبانی نمی‌کند.");
      return;
    }
    try {
      const backups = await listDailyBackups();
      if (!backups.length) {
        toast("بکاپ روزانه‌ای پیدا نشد.");
        return;
      }
      backups.sort((a, b) => String(b.createdAt || b.dateKey).localeCompare(String(a.createdAt || a.dateKey)));
      const list = backups.map((item) => {
        const createdAt = item.createdAt ? new Date(item.createdAt) : null;
        const timeLabel = createdAt && !Number.isNaN(createdAt.valueOf())
          ? toEnglishDigits(createdAt.toLocaleString("fa-IR"))
          : item.dateKey;
        return `${item.dateKey} • ${timeLabel}`;
      }).join("\n");
      const latest = backups[0];
      const ok = confirm(`بکاپ‌های موجود:\n${list}\n\nبازگردانی آخرین بکاپ انجام شود؟`);
      if (!ok) return;
      if (!latest || !isValidBackupState(latest.data)) {
        toast("بکاپ معتبر نیست.");
        return;
      }
      state = latest.data;
      state.settings = { theme: "light", rtl: true, focusMode: false, pinHash: "", pinSalt: "", ...state.settings };
      state.settings.focusMode = !!state.settings.focusMode;
      await migrateLegacyPin();
      saveState();
      renderAll();
      renderDashboardCharts();
      if (hasPinSet() && sessionStorage.getItem(LOCK_SESSION_KEY) !== "1") {
        showLock();
      }
      toast("بکاپ روزانه بازیابی شد ✅");
    } catch {
      toast("بازیابی بکاپ با خطا مواجه شد.");
    }
  });

  $("#btnImportDo").addEventListener("click", async () => {
    const file = $("#importFile").files && $("#importFile").files[0];
    if(!file){ toast("فایلی انتخاب نشده."); return; }
    const text = await file.text();
    const data = safeParse(text);
    if(!data || !data.meta){ toast("فایل معتبر نیست."); return; }
    state = data;
    state.settings = { theme: "light", rtl: true, focusMode: false, pinHash: "", pinSalt: "", ...state.settings };
    state.settings.focusMode = !!state.settings.focusMode;
    await migrateLegacyPin();
    saveState();
    closeDlg("dlgImport");
    renderAll();
    renderDashboardCharts();
    if (hasPinSet() && sessionStorage.getItem(LOCK_SESSION_KEY) !== "1") {
      showLock();
    }
    toast("داده‌ها وارد شد ✅");
  });

  $("#btnReset").addEventListener("click", () => {
    const ok = confirm("ریست کامل؟ همه داده‌ها پاک می‌شوند. قبلش Export بگیر.");
    if(!ok) return;
    state = defaultState();
    saveState();
    sessionStorage.removeItem(LOCK_SESSION_KEY);
    hideLock();
    monthCursor = currentJalaliYM();
    plannerDate = todayISO();
    renderAll();
    renderDashboardCharts();
    toast("ریست شد.");
  });

  // =========================
  // Utilities
  // =========================
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll("\"","&quot;").replaceAll("'","&#039;");
  }

  const applyEnglishDigits = (root = document.body) => {
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    let node;
    while ((node = walker.nextNode())) {
      if (!node.nodeValue || !/[۰-۹]/.test(node.nodeValue)) continue;
      const parent = node.parentElement;
      if (parent) {
        if (parent.closest("input, textarea, select, [contenteditable]:not([contenteditable=\"false\"])")) continue;
        if (parent.tagName === "SCRIPT" || parent.tagName === "STYLE") continue;
      }
      node.nodeValue = toEnglishDigits(node.nodeValue);
    }
  };

  // =========================
  // Render All
  // =========================
  const renderAll = () => {
    renderHeader();
    applyFocusMode();
    updateLockAvailability();
    renderDashboard();
    renderPlanner();
    renderCalendar();
    renderProjects();
    renderGoals();
    renderFinance();
    renderNotes();
    applyEnglishDigits();
  };

  let clockTimer = null;
  const startClock = () => {
    updateFlipClock();
    if (clockTimer) clearInterval(clockTimer);
    clockTimer = setInterval(updateFlipClock, 1000);
  };

  // Init
  const boot = async () => {
    await migrateLegacyPin();
    initLock();
    renderAll();
    startClock();
    renderDashboardCharts();
  };
  void boot();
})();
</script>
</body>
</html>
